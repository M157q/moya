{% extends "directory_base.html" %}

{% block "title" %}Directory listing for ${.request.path}{% endblock %}

{% def "show_date" -%}
    {%- cache for 1d key [dt, .now.local.date] %} {%- compact %}

    {%- if dt %}
    {% if dt.local.date == .now.local.date %}Today{% else %}${localize:dt.local.date}{% endif %}<span class="text-muted hidden-xs hidden-sm">, ${localize:dt.local.time}</span>
    {%- endif %}

    {%- end-compact %} {%- end-cache %}
{%- end-def %}

{% block "content" %}

{%- let dir_count = count:[directory, `is_dir`] %}
{%- let file_count = len:directory - dir_count %}

<div class="container">

    <h3 class="page-header text-center" title="${.request.path_info}">
        {%- if path != '/' %}<a class="btn btn-link pull-left" href="../">&crarr; parent</a>{% endif %}
        ${.request.path_info}
    </h3>

    {%- if .debug %}<pre>${fs[path]}</pre>{% endif %}
    {%- if directory %}
    <table class="table table-condensed table-striped">
        <thead>
        	<tr>
        		<th>Name</th>
                <th class="file-size">Size</th>
        		<th class="hidden-xs">Created</th>
        		<th class="hidden-xs">Modified</th>
                {% if show_permissions or .debug %}
                <th class="hidden-sm hidden-xs">User</th>
                <th class="hidden-sm hidden-xs">Group</th>
                <th class="hidden-sm hidden-xs permissions">Permissions</th>
                {% endif %}
        	</tr>
        </thead>
        <tbody>
            <!-- TODO: path.replace('#', '%23') -->
        	{%- for info in sortedby:[directory, `[not is_dir, lower:name]`] %}
        	<tr>
        		<td>
                    <a {% attrib href=info.name + '/', class=info.type.name, title=info.type.name %}>
                        ${info.name}
                    </a>
                </td>
                {%- if info.is_dir %}
                <td>&nbsp;</td>
                {%- else %}
                <td class="file-size" title="(${info.size::','} bytes)">${filesize:info.size}</td>
                {%- endif %}
                <td class="hidden-xs">{% call "show_date" with dt=info.created %}</td>
                <td class="hidden-xs">{% call "show_date" with dt=info.modified %}</td>
                {% if show_permissions or .debug %}
                <td class="hidden-sm hidden-xs">${info.user}</td>
                <td class="hidden-sm hidden-xs">${info.group}</td>
                <td class="hidden-sm hidden-xs permissions"><tt>${info.permissions}</tt></td>
                {% endif %}
        	</tr>
        	{%- endfor %}
        </tbody>
    </table>
    {%- endif %}
    <p>
        <div class="pull-right"><a href="${app.lib.url}">moya.static ${app.lib.version}</a></div>
        <strong>${filesize:sum:map:[directory, `is_dir ? 0 : size`]}</strong>
        in ${file_count::','} {% if file_count == 1 %}file{% else %}files{% endif %}.
    	${dir_count::','} {% if dir_count == 1 %}directory{% else %}directories{% endif %}.
    </p>
    <br/>
</div>
{% endblock %}
