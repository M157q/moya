<!DOCTYPE html>
<!-- saved from url=(0065)http://twitter.github.io/bootstrap/examples/starter-template.html -->
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>Databases</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le styles -->
        <link href="assets/css/bootstrap.css" rel="stylesheet">
        <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
        <link href="assets/css/custom.css" rel="stylesheet">

        <style>
        
        </style>
    </head>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

  <body>
    <div id="wrap">
    <div id="main-nav" class="navbar navbar-default navbar-static-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".doc-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="index.html">Moya Documentation</a>
            </div>
            <nav class="collapse navbar-collapse doc-navbar-collapse" role="navigation">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="index.html">Reference</a>
                    </li>
                    <li >
                        <a href="tags/index.html">Tags</a>
                    </li>
                    <li >
                        <a href="tutorial.html">Tutorial</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    
<div class="container">
    <div class="row">
        <div class="doc-content col-md-9">
            

<div class="doc-nav">
    <ul class="pager">
        <li class="previous">
            <a href="content.html">&larr; 13. Content</a>
        </li>
        
        <li class="next">
            <a href="email.html">15. Email &rarr;</a>
        </li>
    </ul>
</div>


            <h1>Databases</h1>
            <p>This chapter covers how you can work with Databases in a Moya project.</p>
<p>Most web applications use a <em>database</em> to store <em>dynamic</em> (changeable) data, required to implement standard features of a web site such as users logins, sessions, comments etc. Databases are so ubiquitous it is hard to imagine a feature that <em>doesn't</em> need to use one.</p>
<p>Working with databases has traditionally meant writing <a href="http://en.wikipedia.org/wiki/SQL">SQL</a> which &ndash; although powerful &ndash; has a fairly steep learning curve. Moya has it's own interface to databases which saves a lot of time in development and doesn't require you to work directly with SQL (although if you already know SQL it will be an advantage).</p>
<aside>Moya gains it's database capabilities from <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>, a powerful database toolkit. </aside> <h2><a name="database-settings"></a><a href="#database-settings">Database Settings<span class="anchor"> &#182;</span></a></h2><p>There are a number of settings Moya needs in order to connect to a database. To define a database, add a named section called <code>db</code> with a name to identify the database in code. Here's an example of a database section in a settings file:</p>
<pre class="moya-console format-ini"><div class="line line-1"></span><span class="section key">[</span><span class="section sectiontype key">db</span><span class="section key">:</span><span class="section key sectionname">main</span><span class="section key">]</span><span class="key"></span></div><div class="line line-2"><span class="key">engine&nbsp;</span>=</span><span class="value">&nbsp;sqlite:///basic.sqlite</span></div><div class="line line-3"></span><span class="key">default&nbsp;</span>=</span><span class="value">&nbsp;yes</span></div><div class="line line-4"></span><span class="key">echo&nbsp;</span>=</span><span class="value">&nbsp;no</span></div></pre><p>This tells Moya to connect to a database, which will be referred to by the name <code>main</code> in code. The name of the database is only important if make use of multiple databases in your projects and you need to tell Moya which one you wish to work with. Most projects will only ever use one database, so a generic name like <code>main</code> is probably a good choice. The following settings should be specified in the <code>db</code> section:</p>
<p class="setting">engine =<span class="value"> &lt;engine&gt;</span></p><p>This tells Moya which kind if database you wish to connect to. See <a href="db.html#supported-databases" title="Databases">Supported Databases</a> for what to specify here.</p>
<p class="setting">default =<span class="value"> &lt;yes/no&gt;</span></p><p>This tells Moya that the database should be the <em>default</em>, and should be used if you don't specify which database you are using in a database tags. This setting is only required if you have more than one database specified.</p>
<p class="setting">echo =<span class="value"> &lt;yes/no&gt;</span></p><p>When set to <code>yes</code>, Moya will write the SQL generated by database operations to the console. This can be helpful if you are debugging.</p>
<h3><a name="multiple-databases"></a><a href="#multiple-databases">Multiple Databases<span class="anchor"> &#182;</span></a></h3><p>You can specify as many databases as you need in your application (although its rare to have more than one). If you have multiple databases, you can specify which database to use with the <code>db</code> attribute of database related tags. Otherwise Moya will use the database with <code>default</code> set to <code>yes</code>.</p>
<h2><a name="supported-databases"></a><a href="#supported-databases">Supported Databases<span class="anchor"> &#182;</span></a></h2><p>Moya supports a number of different SQL databases which may be specified in the <code>engine</code> setting. The format of <code>engine</code> depends on the database you are using. This section lists the supported databases and how to construct the value of <code>engine</code>.</p>
<aside>Installing and configuring a database isn't covered here. If you are unfamiliar with setting up a database, you should be able to find plenty of information on the internet to help you (it doesn't need to be Moya specific).</aside><h3><a name="sqlite"></a><a href="#sqlite">SQLite<span class="anchor"> &#182;</span></a></h3><p>SQLLite is a database that is contained entirely within a single file. SQLLite databases can be useful in development as they don't require installing any additional software, and if you need to start from scratch you can simply delete the database file. SQLLite databases are not often used for larger sites because it is not easy to share an SQLite database across multiple servers.</p>
<p>To specify an SQLLite database, set <code>engine</code> to <code>sqllite:///</code> followed by the filename of the sqllite database. Here's an example:</p>
<pre class="moya-console format-ini"><div class="line line-1"></span><span class="section key">[</span><span class="section sectiontype key">db</span><span class="section key">:</span><span class="section key sectionname">main</span><span class="section key">]</span><span class="key"></span></div><div class="line line-2"><span class="key">engine&nbsp;</span>=</span><span class="value">&nbsp;sqlite:///example.sqlite</span></div></pre><p>This will store the database in a file called <code>example.sqlite</code> (the extension is not important).</p>
<p>SQLite is the default for the <code>start project</code> command &ndash; if you want to get up and running quickly then you can leave the database setting unchanged. If you do need to connect to a database, then see one of the following sections:</p>
<h3><a name="mysql"></a><a href="#mysql">MySQL<span class="anchor"> &#182;</span></a></h3><p>To connect to a <a href="http://www.mysql.com/">MySQL</a> database, use a value for <code>engine</code> in the following format:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">mysql://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;/&lt;database&nbsp;name&gt;</div></pre><p>Here's an example:</p>
<pre class="moya-console format-ini"><div class="line line-1"></span><span class="section key">[</span><span class="section sectiontype key">db</span><span class="section key">:</span><span class="section key sectionname">main</span><span class="section key">]</span><span class="key"></span></div><div class="line line-2"><span class="key">engine&nbsp;</span>=</span><span class="value">&nbsp;mysql://moya:muchsecret@localhost/moyaexample</span></div></pre><h3><a name="postgressql"></a><a href="#postgressql">PostgresSQL<span class="anchor"> &#182;</span></a></h3><p>Specifying a PostgresSQL database is similar to <a href="db.html#mysql" title="Databases">MySQL</a>. The value for <code>engine</code> should be in the following format:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">postgres://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;/&lt;database&nbsp;name&gt;</div></pre><h3><a name="oracle"></a><a href="#oracle">Oracle<span class="anchor"> &#182;</span></a></h3><p>To connect to an Oracle database, the value for <code>engine</code> should be in the following format:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">oracle://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;/&lt;database&nbsp;name&gt;</div></pre><h2><a name="db-command"></a><a href="#db-command">DB Command<span class="anchor"> &#182;</span></a></h2><p>You can perform some database related tasks from the command line with the <code>db</code> subcommand. This subcommand has a number of further subcommands. The following commandline will list the available db subcommands:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">moya&nbsp;db&nbsp;-h</div></pre><p>We will cover database subcommands in this document.</p>
<h2><a name="models"></a><a href="#models">Models<span class="anchor"> &#182;</span></a></h2><p>A <em>model</em> defines an object type which will be stored in a table in the database. Models contain a number of <em>fields</em> which define the data associated with the model (text, number etc).</p>
<p>To create a model, use the <code>model</code> tag in the <code>http://moyaproject.com/db</code> namespace. It is customary to put your models in a file called <code>models.xml</code>, but you may want to split your models in to multiple files if you have many of them.</p>
<p>Let's look at an example of a simple model. The following defines a model with two string fields:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">moya</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Character"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"character&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"20"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;default=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="endtagname tag">/moya</span><span class="tag">&gt;</span></div></pre><p>Note the use of the <code>xmlns</code> attribute which sets the namespace to <code>http://moyaproject.com/db</code>. All database related tags are defined in this namespace. The <code>libname</code> attribute has the same meaning as other tags in Moya, and is also used to identify the model in queries (see below).</p>
<p>The attribute <code>repr</code> on a <a class="tag" href="tags/httpmoyaprojectcomdb/tag_model.html">&lt;model&gt;</a> tag tells Moya what to display when you print a model object to the console or log. It is not required, but can be very helpful during debugging.</p>
<p>Before we can use this model we must first create the tables in the database. We can do this with the following commandline:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">moya&nbsp;db&nbsp;sync</div></pre><p>When you run this from the project directory, Moya will extract all the <code>model</code> tags from your project and create the table(s) in the database. The name of the table in the database is generated from the name of the application and the name of the model. A model's name is assumed to be the same as the <code>libname</code> in lower case, except if you explicitly supply the <code>name</code> parameter, which is used in preference. So if the preceding example was in an application called <code>moya</code>, the table name would be <code>moya_character</code>.</p>
<h3><a name="fields"></a><a href="#fields">Fields<span class="anchor"> &#182;</span></a></h3><p>To add a field to a table, simply specify it inside a <a class="tag" href="tags/httpmoyaprojectcomdb/tag_model.html">&lt;model&gt;</a>. There are a number of fields to store different types of information. We've seen the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_string.html">&lt;string&gt;</a> tag which adds string of a specific length to a model. There are other fields to store different types of data, such as numbers, text, dates etc. Other field types define how tables <em>relate</em> to each other.</p>
<h3><a name="model-references"></a><a href="#model-references">Model References<span class="anchor"> &#182;</span></a></h3><p>Models are referenced in Moya code the same way as other elements. The preceding example had a libname of <code>Character</code> and may be referenced with <code>#Character</code> &ndash; from the same library. If you want to reference a model from another library then you need to precede the <code>#</code> with the name of the application. For example, if the <code>#Character</code> is in an application called <code>moya</code>, it may be referenced as <code>moya#Character</code>. You can also use the library long name in place of the application <em>if</em> the library is installed just once.</p>
<h3><a name="creating-model-objects"></a><a href="#creating-model-objects">Creating Model Objects<span class="anchor"> &#182;</span></a></h3><p>You can create an object in the database with the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_create.html">&lt;create&gt;</a> tag. The model is specified in the <code>model</code> attribute. The fields are specified in the same way as a data setter tag (e.g. <a class="tag" href="tags/httpmoyaprojectcom/tag_dict.html">&lt;dict&gt;</a>). The following code adds a new <em>character</em> to the database:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">str</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"name"</span><span class="tag">&gt;</span>John</span><span class="tag">&lt;</span><span class="endtagname tag">/str</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">str</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"species"</span><span class="tag">&gt;</span>Human</span><span class="tag">&lt;</span><span class="endtagname tag">/str</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/db:create</span><span class="tag">&gt;</span></div></pre><p>You may also use the LET extension to specify the field data as follows:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent"></span></div><a name="line2"></a><div class="line line-2"><span class="tag tagcontent">&nbsp;&nbsp;&nbsp;&nbsp;let:name=</span><span class="attrib tag tagcontent">"John"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"Human"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>When the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_create.html">&lt;create&gt;</a> runs it stores a model object in the value specified in <code>dst</code>. You can access the fields of a model object, in the same way as any other data. For example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{character.name}</span>&nbsp;is&nbsp;a&nbsp;</span><span class="sub">$</span><span class="braced sub">{character.species}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>Models also have an implicit field called <code>id</code> which is the <em>primary</em> key. This value starts at <code>1</code> and increments every time you create a new model object. i.e. the first <code>Character</code> will have an id of <code>1</code>, the second will have id <code>2</code> etc.</p>
<p>You can access this field as any other in the model. But if you were to refer to <code>character.id</code> immediately after creating it, you would find the value to be <code>None</code>. This is because the new character has not yet been <em>inserted</em> in to the database. Generally Moya inserts new objects at the end of the request. If you do need the <code>id</code> value at the point you create the object, you can force new objects to be inserted immediately with <a class="tag" href="tags/httpmoyaprojectcomdb/tag_commit.html">&lt;commit&gt;</a>. For example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent"></span></div><a name="line2"></a><div class="line line-2"><span class="tag tagcontent">&nbsp;&nbsp;&nbsp;&nbsp;let:name=</span><span class="attrib tag tagcontent">"John"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"Human"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{character.name}</span>&nbsp;is&nbsp;a&nbsp;</span><span class="sub">$</span><span class="braced sub">{character.species}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">commit</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>id&nbsp;is&nbsp;</span><span class="sub">$</span><span class="braced sub">{character.id}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><h3><a name="common-field-attributes"></a><a href="#common-field-attributes">Common Field Attributes<span class="anchor"> &#182;</span></a></h3><p>There are some common attributes used by database <a href="db.html#field-reference" title="Databases">field tags</a> that have the same meaning.</p>
<p>The <code>null</code> attribute is a boolean which allows the use of a <code>NULL</code> value in the database column. A value of <code>NULL</code> translates as <code>None</code> in Moya and is generally used to indicate <em>not applicable</em> or <em>no value</em> in a database object.</p>
<p>The <code>default</code> attribute sets the value used if no value is given when the object is created.</p>
<p>The <code>unique</code> attribute is a boolean which tells Moya to impose a <em>unique</em> constraint on the database table. This means that if you try to create an object with a field the same as an existing object, Moya will raise a <code>db.integrity-error</code> exception.</p>
<p>The <code>label</code> attribute should be the human readable name of the field, and <code>help</code> should be a one-sentence description of the field purpose. Both are optional and used when builing forms to create / edit a model object.</p>
<h3><a name="unique-fields"></a><a href="#unique-fields">Unique Fields<span class="anchor"> &#182;</span></a></h3><p>The <code>unique</code> attribute on a field tag ensures that the particular value will appear exactly once in the table. let's look at a model with a unique field:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Ship"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"ship&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;unique=</span><span class="attrib tag tagcontent">"yes"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"type"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>We can create a <code>#Ship</code> object with the following:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Ship"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"Moya"</span><span class="tag tagcontent">&nbsp;let:type=</span><span class="attrib tag tagcontent">"Leviathan"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>Because the <code>name</code> field has <code>unique="yes"</code>, if we try to create another ship with the same name, Moya will raise a <code>db.integrity-error</code> exception. For example, the follow code will detect the exception:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Ship"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"Moya"</span><span class="tag tagcontent">&nbsp;let:type=</span><span class="attrib tag tagcontent">"Command&nbsp;Carrier"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">catch</span><span class="tag tagcontent">&nbsp;exception=</span><span class="attrib tag tagcontent">"db.integrity-error"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>A&nbsp;ship&nbsp;of&nbsp;that&nbsp;name&nbsp;already&nbsp;exists!</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/catch</span><span class="tag">&gt;</span></div></pre><p>It is also possible to apply a unique restraint to a group of fields with the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_unique-together.html">&lt;unique-together&gt;</a>. The following applies a unique restraint to <code>name</code> and <code>type</code>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Ship"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"ship&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">unique-together</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"type"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/unique-together</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">text</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"description"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;default=</span><span class="attrib tag tagcontent">""</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>This code ensures that the <em>combination</em> of <code>name</code> and <code>type</code> is unique &ndash; so there could only be one ship with name <code>Moya</code> <em>and</em> type <code>leviathan</code>, but potentially other ships called <code>Moya</code> with a different <code>type</code>.</p>
<h3><a name="foreign-keys"></a><a href="#foreign-keys">Foreign Keys<span class="anchor"> &#182;</span></a></h3><p>A <em>foreign key</em> is a link from one model to another. Let's add a foreign key field to the Character model which links to a Ship model. Here are new models:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Ship"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"ship&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;unique=</span><span class="attrib tag tagcontent">"yes"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"type"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"><br></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Character"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"character&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line8"></a><div class="line line-8">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"20"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;default=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line9"></a><div class="line line-9">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">foreign-key</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"ship"</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Ship"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"yes"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line10"></a><div class="line line-10"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>Now Character model objects will have the attribute <code>ship</code>, which may be set to <code>None</code> or to a ship model. This is demonstrated by the following code which creates a Ship and a Character model:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Ship"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"moya"</span><span class="tag tagcontent"></span></div><a name="line2"></a><div class="line line-2"><span class="tag tagcontent">&nbsp;&nbsp;&nbsp;&nbsp;let:name=</span><span class="attrib tag tagcontent">"'Moya'"</span><span class="tag tagcontent">&nbsp;let:type=</span><span class="attrib tag tagcontent">"'Leviathan'"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"><br></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"john"</span><span class="tag tagcontent"></span></div><a name="line5"></a><div class="line line-5"><span class="tag tagcontent">&nbsp;&nbsp;&nbsp;&nbsp;let:name=</span><span class="attrib tag tagcontent">"'John'"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"'human'"</span><span class="tag tagcontent"></span></div><a name="line6"></a><div class="line line-6"><span class="tag tagcontent">&nbsp;&nbsp;&nbsp;&nbsp;let:ship=</span><span class="attrib tag tagcontent">"moya"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>With the <code>ship</code> attribute set, you can now refer to the character's ship as <code>john.ship</code>, and it's attributes (e.g. <code>john.ship.name</code>).</p>
<h4><a name="backrefs"></a><a href="#backrefs">Backrefs<span class="anchor"> &#182;</span></a></h4><p>We've seen that the foreign key has created a link from a Character to a Ship. It also possible to establish a link in the <em>reverse</em> direction with the <code>backref</code> attribute. Let's revise the Character model to add a backref:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Character"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"20"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;default=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">foreign-key</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"ship"</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Ship"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"yes"</span><span class="tag tagcontent">&nbsp;backref=</span><span class="attrib tag tagcontent">"characters"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>The addition of the <code>backref</code> attribute (on Character) has created an attribute called <code>characters</code> on the Ship model. This attribute is a <em>list</em> of all the Character objects that have a foreign key to that ship. Here's how you could list all characters for a ship:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">for</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"ship.characters"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{character}</span>&nbsp;is&nbsp;on&nbsp;board&nbsp;</span><span class="sub">$</span><span class="braced sub">{ship}</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/for</span><span class="tag">&gt;</span></div></pre><h4><a name="one-to-one"></a><a href="#one-to-one">One to One<span class="anchor"> &#182;</span></a></h4><p>A variation of the foreign key is a <em>one to one</em>, which establishes a foreign key relationship where there is only ever one link. For example, if we had used a one-to-one rather than a foreign key on the the Character model, then a ship have at most one associated character.</p>
<p>This is reflected in the <code>backref</code> attribute which creates a link rather than a list. Let's look at what would happen if we made the <code>ship</code> foreign key a one-to-one:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Character"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"20"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;default=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">one-to-one</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"ship"</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Ship"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"yes"</span><span class="tag tagcontent">&nbsp;backref=</span><span class="attrib tag tagcontent">"character"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>Here we have changed the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_foreign-key.html">&lt;foreign-key&gt;</a> tag to a <a class="tag" href="tags/httpmoyaprojectcomdb/tag_one-to-one.html">&lt;one-to-one&gt;</a> tag. We've also changed the value of the <code>backref</code> attribute from <code>characters</code> to <code>character</code>. The result is that we can access the ship from the character with <code>character.ship</code> and also access the character from the ship with <code>ship.character</code>.</p>
<aside>You could do <b>character.ship.character.ship</b>, but that would be madness.</aside><h3><a name="model-relationships"></a><a href="#model-relationships">Model Relationships<span class="anchor"> &#182;</span></a></h3><p>We've seen that when you add a foreign key to a model, you can also create a list on the object referenced by the foreign key that represents the reverse side of the foreign key (via the <code>backref</code> attribute). This is an example of a model <em>relationship</em>. Moya supports a variety of other ways to establish such relationships that reflect how your models relate to each other.</p>
<h3><a name="many-to-many"></a><a href="#many-to-many">Many to Many<span class="anchor"> &#182;</span></a></h3><p>A <em>many to many</em> relationship is where two models share a relationship. So if we have two models, A and B; then an A object may be associated with any number of B objects, and B objects may be associated with any number of A objects.</p>
<p>Lets look at more tangible example to demonstrate this. Our Character model has a <code>species</code> attribute which is a string. This will limit us if we want to store some information about the species, such as the planet of origin. Let's define a Species model for more flexibility:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Species"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"species&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"planet"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"20"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>We can add a few Species objects with the following:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Species"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'Human'"</span><span class="tag tagcontent">&nbsp;let:planet=</span><span class="attrib tag tagcontent">"'Earth'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Species"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'Sebaccean'"</span><span class="tag tagcontent">&nbsp;let:planet=</span><span class="attrib tag tagcontent">"various"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"sebacean"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Species"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'Luxan'"</span><span class="tag tagcontent">&nbsp;let:planet=</span><span class="attrib tag tagcontent">"'Luxan&nbsp;terratories'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"luxan"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>Naturally, a <em>species</em> may have any number of <em>characters</em>. And a character will belong to <em>at least</em> one species &ndash; more in the case of hybrids. This can be represented in the model with a <a class="tag" href="tags/httpmoyaprojectcomdb/tag_many-to-many.html">&lt;many-to-many&gt;</a> tag, which may be added to either side of the relationship (character or species) but lets replace the species field on Character:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Character"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"character&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">many-to-many</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Species"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>Now when we create a character, we will have a <code>species</code> attribute which is a <em>list</em> of Species objects. Let's create a character with one species:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'John'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"john"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">append</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"john.species"</span><span class="tag tagcontent">&nbsp;value=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{john.species}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>Here we have created a Character called John, and associated him with the previously created <code>human</code> species by appending to the <code>species</code> list. We can create a hybrid character by adding more than one Species. Here's an example of creating a character that is half <em>Sebaccean</em> and half <em>Luxan</em>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'Jothee'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"jothee"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">append</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"jothee.species"</span><span class="tag tagcontent">&nbsp;value=</span><span class="attrib tag tagcontent">"Sebaccean"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">append</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"jothee.species"</span><span class="tag tagcontent">&nbsp;value=</span><span class="attrib tag tagcontent">"luxan"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{jothee.species}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>To retrieve the reverse side of the relationship, we can add a <code>backref</code> attribute to the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_many-to-many.html">&lt;many-to-many&gt;</a>. Let's add a backref to the Species model:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">many-to-many</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Species"</span><span class="tag tagcontent">&nbsp;backref=</span><span class="attrib tag tagcontent">"characters"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>Now we can view all characters for a given species via a <code>characters</code> attribute. Here's how we can list all the Humans in the database:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">for</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"human.characters"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{character}</span>&nbsp;is&nbsp;a&nbsp;human</span><span class="tag">&lt;</span><span class="tag tagcontent">/echo?</span></div><a name="line3"></a><div class="line line-3"><span class="tag tagcontent">&lt;</span><span class="endtagname tag">/for</span><span class="tag">&gt;</span></div></pre><h2><a name="getting-model-objects"></a><a href="#getting-model-objects">Getting Model Objects<span class="anchor"> &#182;</span></a></h2><p>You can retrieve an object from the database with <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get.html">&lt;get&gt;</a>, which queries (looks up) the database for an object with matching fields. Here's how you could retrieve the object inserted with <a class="tag" href="tags/httpmoyaprojectcomdb/tag_create.html">&lt;create&gt;</a>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">str</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"name"</span><span class="tag">&gt;</span>John</span><span class="tag">&lt;</span><span class="endtagname tag">/str</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/db:get</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>John&nbsp;is&nbsp;a&nbsp;</span><span class="sub">$</span><span class="braced sub">{character.species}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>This finds the <code>#Character</code> with a value of <code>name</code> set to <code>John</code>. You can also use the LET extension to specify fields, as follows:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"John"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>If there is no matching object in the database, then <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get.html">&lt;get&gt;</a> will store the value of <code>None</code> in <code>dst</code>. You can use this to determine if an object exists or not as follows:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"Will"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"character&nbsp;is&nbsp;None"</span><span class="tag">&gt;</span>I&nbsp;don't&nbsp;know&nbsp;what&nbsp;species&nbsp;Will&nbsp;is</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>If there are more than one matching object in the database then Moya will return one of them. Normally, you won't be able to know in advance which object will be returned, but if you specify the <code>orderby</code> attribute, Moya will sort the results by this field and return the first one. For instance, lets get a character that has a <code>species</code> of <code>Human</code>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"Human"</span><span class="tag tagcontent">&nbsp;orderby=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>If there is more than one Human in the database, Moya will return the character with a name that comes first in alphabetical order.</p>
<h3><a name="getting-exactly-one"></a><a href="#getting-exactly-one">Getting Exactly One<span class="anchor"> &#182;</span></a></h3><p>An alternative to <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get.html">&lt;get&gt;</a> which assumes there is exactly one result is <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get-one.html">&lt;get-one&gt;</a>. This tag works like <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get.html">&lt;get&gt;</a>, but will throw an exception if there are no results (rather than return <code>None</code>). It will also throw an exception if there are <em>multiple</em> results. Here's an example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"Human"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"Rygel"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">catch</span><span class="tag tagcontent">&nbsp;exception=</span><span class="attrib tag tagcontent">"db.no-result"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>No&nbsp;Humans&nbsp;called&nbsp;Rygel!</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/catch</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="tag tagname">catch</span><span class="tag tagcontent">&nbsp;exception=</span><span class="attrib tag tagcontent">"db-multiple-results"</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>There&nbsp;are&nbsp;multiple&nbsp;humans&nbsp;called&nbsp;Rygel!</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="endtagname tag">/catch</span><span class="tag">&gt;</span></div></pre><p>This will attempt to find exactly one Human called Rygel, and will handle the case where there are None, or more than one.</p>
<p>The tags <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get.html">&lt;get&gt;</a> and <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get-one.html">&lt;get-one&gt;</a> are often interchangeable, but <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get-one.html">&lt;get-one&gt;</a> is useful for catching errors in your database, which might otherwise produce unexpected results</p>
<h3><a name="get-required"></a><a href="#get-required">Get Required<span class="anchor"> &#182;</span></a></h3><p>It is a fairly frequent requirement to get a database object which will be used to generate a page (a blog post for example). In these cases you would want to display a 404 (not found) page if the object <em>does not</em> exists. For example, lets say we have a page for each character in our database and the url <a href="urls.html#url-routes" title="URLs, Views and Middleware">route</a> is <code>/character/{name}/</code>. The view would do the following to look up a character:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"url.name"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">not-found</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"not&nbsp;character"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>If you were to visit a url such as <code>/character/will/</code> (and there is no character called <code>will</code>), then <code>character</code> will be <code>None</code> and the following line will return the 404 response.</p>
<p>This code can be simplified with <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get-required.html">&lt;get-required&gt;</a> which works like <a class="tag" href="tags/httpmoyaprojectcomdb/tag_get.html">&lt;get&gt;</a>, but will return the not found response automatically if the object does not exist. Here's how we could re-write the above code:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get-required</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"url.name"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><h2><a name="modifying-model-objects"></a><a href="#modifying-model-objects">Modifying Model Objects<span class="anchor"> &#182;</span></a></h2><p>Once you have a model object, you may make changes simply by setting the attributes. For example, the following code retrieves an object then modifies an attribute:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"John"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"john"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">let</span><span class="tag tagcontent">&nbsp;john.species=</span><span class="attrib tag tagcontent">"Hynerian"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>This will issue an <em>update</em> to the database to modify the <code>species</code> column and turn John in to a Hynerian. The changes may not be made permanent until the next commit (see <a href="db.html#transactions" title="Databases">Transactions</a>). You can force Moya to modify the database object immediately with the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_commit.html">&lt;commit&gt;</a> tag.</p>
<h2><a name="queries"></a><a href="#queries">Queries<span class="anchor"> &#182;</span></a></h2><p>For more sophisticated <em>querying</em>, especially where you need to retrieve more than one object, Moya offers the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_query.html">&lt;query&gt;</a> tag. Let's look at a very simple use of this tag:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>This line of code returns a <em>queryset</em>, which is an object that represents the results of a query. In this case, the queryset will give us all Character objects in the database.</p>
<p>When the queryset is created, Moya has not yet retrieved any results from the database. To actually get the results from a queryset you can <em>iterate</em> over it, in Moya Code or a template. Here's how you might display the results of the previous query:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">for</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"character"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{character.name}</span>&nbsp;is&nbsp;a&nbsp;</span><span class="sub">$</span><span class="braced sub">{character.species}</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/for</span><span class="tag">&gt;</span></div></pre><p>Alternatively, Moya querysets have a few attributes which can return results or other information regarding the queryset. You can retrieve the first result in the query with <code>queryset.first</code>, the total number of results can be retrieved with <code>queryset.count</code>, a boolean that indicates if there are at least one result may be retrieved with <code>queryset.exists</code>, and the queryset can be retrieved as a list with <code>queryset.list</code>. The following code demonstrates how to use some of those queryset attributes:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span><span class="sub">$</span><span class="braced sub">{characters.count}</span>&nbsp;result(s)</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>First&nbsp;result:&nbsp;</span><span class="sub">$</span><span class="braced sub">{characters.first}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag tagcontent">&nbsp;obj=</span><span class="attrib tag tagcontent">"characters.list"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><h3><a name="filtering-queries"></a><a href="#filtering-queries">Filtering Queries<span class="anchor"> &#182;</span></a></h3><p>As well as retrieving <em>all</em> objects stored in the database, you can also <em>filter</em> results with the <code>filter</code> attribute, which takes a <em>database expression</em>. Data expressions look similar to the expressions used elsewhere in Moya, but are converted to SQL.</p>
<p>The following example retrieves all Characters with the name of <code>John</code>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;filter=</span><span class="attrib tag tagcontent">"#Character.name&nbsp;==&nbsp;'John'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"johns"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The filter attribute <code>#Character.name == 'John'</code> tells Moya to filter results with the <code>name</code> column of <code>#Character</code> set to <code>'John'</code>. Database expressions can also express more sophisticated conditions with multiple fields. See the <a href="db.html#database-expressions" title="Databases">Database Expressions</a> section for the full details.</p>
<h3><a name="sorting-querysets"></a><a href="#sorting-querysets">Sorting Querysets<span class="anchor"> &#182;</span></a></h3><p>The <a class="tag" href="tags/httpmoyaprojectcomdb/tag_query.html">&lt;query&gt;</a> tag can also sort results by a field on the model. You can specify the field to sort on with the <code>orderby</code> field. Here's an example that sorts the Characters by <em>name</em>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;orderby=</span><span class="attrib tag tagcontent">"name"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>By default, queries are sorted in ascending order (A-&gt;Z for string fields). You can specify <em>descending</em> order (Z-&gt;A) in one of two ways; you can either precede the <code>orderby</code> attribute with a hyphen, or set the <code>reverse</code> field to <code>yes</code>. The following two lines are equivalent:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;orderby=</span><span class="attrib tag tagcontent">"-name"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;orderby=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;reverse=</span><span class="attrib tag tagcontent">"yes"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>You can sort by more than one field by listing them in the <code>orderby</code> attribute separated by commas. For example, the following sorts first by the <code>name</code> field, then the <code>species</code> field:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;orderby=</span><span class="attrib tag tagcontent">"name,species"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><h3><a name="querying-columns"></a><a href="#querying-columns">Querying Columns<span class="anchor"> &#182;</span></a></h3><p>Sometimes you only need to retrieve a few columns from each object, rather than the entire object. For these situations you can omit the <code>model</code> attribute, and specify the fields you are interested in with the <code>columns</code> attribute. For example, the following will retrieve just the names of the Characters:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;columns=</span><span class="attrib tag tagcontent">"#Character.name,#Character.species"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag tagcontent">&nbsp;obj=</span><span class="attrib tag tagcontent">"characters.list"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The above code will return a list of fields for each result. For example if there is one result it would return something like the following:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">[['John',&nbsp;'Human']]</div></pre><p>If you are only interested in a single column in a queryset you can specify the <code>flat</code> attribute which tells Moya to return a list of columns rather than a list of lists. Here's an example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;columns=</span><span class="attrib tag tagcontent">"#Character.name"</span><span class="tag tagcontent">&nbsp;flat=</span><span class="attrib tag tagcontent">"yes"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>This will return something like the following:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">['John']</div></pre><div class="alert alert-warning">
Note that when you retrieve columns, you won't be able to make persistent changes by modifying the results.
</div><h3><a name="limiting-results"></a><a href="#limiting-results">Limiting Results<span class="anchor"> &#182;</span></a></h3><p>You can specify a range of results to return with the <code>start</code> and <code>maxresults</code> attributes; <code>start</code> is the index of the first result you want to retrieve, and <code>maxresults</code> is the maximum number of results you want to retrieve. You may want to do this if you are paginating results, for example.</p>
<p>Here's how you might retrieve a <em>page</em> of results:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;start=</span><span class="attrib tag tagcontent">"(page&nbsp;-&nbsp;1)&nbsp;*&nbsp;10"</span><span class="tag tagcontent">&nbsp;maxresults=</span><span class="attrib tag tagcontent">"10"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The above assumes a variable called <code>page</code> which should be a page number (starting from 1), and 10 results per page.</p>
<h3><a name="refining-queries"></a><a href="#refining-queries">Refining Queries<span class="anchor"> &#182;</span></a></h3><p>It is possible to take an existing queryset object and further refine it. This is occasionally useful for more complex queries that can be simplified in to a number of steps. You can do this by suppling a queryset with the <code>src</code> attribute.</p>
<p>For example, the following performs a query in two steps:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;filter=</span><span class="attrib tag tagcontent">"#Character.name=='John'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"johns"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"johns"</span><span class="tag tagcontent">&nbsp;filter=</span><span class="attrib tag tagcontent">"#Character.species=='Human'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"human_johns"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag tagcontent">&nbsp;obj=</span><span class="attrib tag tagcontent">"human_johns.list"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><h3><a name="updating"></a><a href="#updating">Updating<span class="anchor"> &#182;</span></a></h3><p>It is possible to update every object in a queryset with the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_update.html">&lt;update&gt;</a> tag. This is more efficient that modifying objects in memory, as the update can happen entirely on the database.</p>
<p>The <a class="tag" href="tags/httpmoyaprojectcomdb/tag_update.html">&lt;update&gt;</a> tag has a single attribute, <code>src</code>, which should be the queryset you wish to update. The fields you wish to modify are specified with the LET extension. Here's an example that changes the species field of all human Characters to <code>'Scarran'</code></p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;filter=</span><span class="attrib tag tagcontent">"#Character.species=='Human'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"humans"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">update</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"humans"</span><span class="tag tagcontent">&nbsp;let:species==</span><span class="attrib tag tagcontent">"'Scarran'"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The value of a field may be set with a <a href="db.html#database-expressions" title="Databases">database expression</a>, which allows you to refer to multiple fields in the update. The following code, gets a query for all Characters, and updates the <code>species</code> field to <code>"#Character.species + ' Scarran hybrid'"</code>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">update</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"characters"</span><span class="tag tagcontent">&nbsp;let:species==</span><span class="attrib tag tagcontent">"#Character.species&nbsp;+&nbsp;'&nbsp;Scarran&nbsp;hybrid'"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The result would be the species field being changed to the Characters's species plus <code>' Scarran hybrid'</code>. Humans, for example, would become <code>Human Scarran hybrid</code> and Hynerians would begine <code>Hynerian Scarran hybrid</code>.</p>
<h2><a name="deleting-model-objects"></a><a href="#deleting-model-objects">Deleting Model Objects<span class="anchor"> &#182;</span></a></h2><p>You can <em>delete</em> an object from the database with the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_delete.html">&lt;delete&gt;</a> tag which takes the object to delete in the <code>src</code> attribute. Here's how you can delete an object you have previously retrieved:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'Rygel'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"rygel"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">delete</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"rygel"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>You can also supply a queryset in the src attribute, which will delete all objects in that queryset. The following code gets a queryset for all human Characters and deletes them:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">query</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"'Human'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"humans"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">delete</span><span class="tag tagcontent">&nbsp;src=</span><span class="attrib tag tagcontent">"humans"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Deleted&nbsp;all&nbsp;humans!</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><h2><a name="transactions"></a><a href="#transactions">Transactions<span class="anchor"> &#182;</span></a></h2><p>A <em>transaction</em> is a database feature that manages when changes to the database are made permanent (this is called <em>commiting</em>). Up to that point it is also possible to <em>roll back</em> any changes made to the database, to the state the database was in after the last commit.</p>
<p>Moya's default behavior is to immediately commit changes following database operations such as <a class="tag" href="tags/httpmoyaprojectcomdb/tag_create.html">&lt;create&gt;</a>, <a class="tag" href="tags/httpmoyaprojectcomdb/tag_update.html">&lt;update&gt;</a> etc. Modifications to database objects through setting attributes, are <em>not</em> committed immediately. Moya will commit any pending changes at the end of a successful request. If there are any un-handled exceptions in the processing of a request, Moya will roll back any pending changes to the last commit, or to the state the database was in at the start of the request.</p>
<p>You can explicitly commit any pending changes with the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_commit.html">&lt;commit&gt;</a> tag. This will ensure that any modifications made to model objects via setting attributes are written to the database. Here's an example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">get-or-create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'John'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"john"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">let-str</span><span class="tag tagcontent">&nbsp;john.description=</span><span class="attrib tag tagcontent">"Bipedal&nbsp;life-form,&nbsp;around&nbsp;6ft&nbsp;tall"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">commit</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>An alternative way of managing when to commit is via the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_transaction.html">&lt;transaction&gt;</a> tag, which ensures that the any changes made within the enclosed block are committed together if there are no un-handled exceptions. If exceptions are thrown (and not handled) within the transaction, the changes are rolled back. This overrides any tags which would otherwise commit (including <a class="tag" href="tags/httpmoyaprojectcomdb/tag_commit.html">&lt;commit&gt;</a>), so that everything is committed together.</p>
<aside>Committing a number of db operations in one group can be more efficient than committing them individually.</aside><p>Lets demonstrate the effects of the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_transaction.html">&lt;transaction&gt;</a> tag. First we will modify the Character model slightly to make the <code>name</code> and <code>species</code> fields <a href="db.html#unique-fields" title="Databases">unique</a>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">model</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"Character"</span><span class="tag tagcontent">&nbsp;repr=</span><span class="attrib tag tagcontent">"character&nbsp;</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{name}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;xmlns=</span><span class="attrib tag tagcontent">"http://moyaproject.com/db"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">unique-together</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"name"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"30"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">string</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"species"</span><span class="tag tagcontent">&nbsp;length=</span><span class="attrib tag tagcontent">"20"</span><span class="tag tagcontent">&nbsp;null=</span><span class="attrib tag tagcontent">"no"</span><span class="tag tagcontent">&nbsp;default=</span><span class="attrib tag tagcontent">"human"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/unique-together</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="endtagname tag">/model</span><span class="tag">&gt;</span></div></pre><p>The addition of <a class="tag" href="tags/httpmoyaprojectcomdb/tag_unique-together.html">&lt;unique-together&gt;</a> ensures that the database will only let us create one of each name/species combination. If the combination already exists, Moya will throw a <code>db.integrity-error</code>. The following code will try to do just that:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">transaction</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'John'"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"'Human'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"john"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">create</span><span class="tag tagcontent">&nbsp;model=</span><span class="attrib tag tagcontent">"#Character"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'John'"</span><span class="tag tagcontent">&nbsp;let:species=</span><span class="attrib tag tagcontent">"'Human'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"clone"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/db:transactions</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="tag tagname">catch</span><span class="tag tagcontent">&nbsp;exception=</span><span class="attrib tag tagcontent">"db.integrity-error"</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Can't&nbsp;clone&nbsp;John!</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="endtagname tag">/catch</span><span class="tag">&gt;</span></div></pre><p>When this code runs, Moya will attempt to create the two model objects in the database. The second <a class="tag" href="tags/httpmoyaprojectcomdb/tag_create.html">&lt;create&gt;</a> will fail because of the unique constraint on the model and throw a <code>db.integrity-error</code>. Because this exception isn't handled inside the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_transaction.html">&lt;transaction&gt;</a>, Moya will rollback the pending changes, so that <em>no</em> new characters are created.</p>
<p>Without the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_transaction.html">&lt;transaction&gt;</a>, the first <a class="tag" href="tags/httpmoyaprojectcomdb/tag_create.html">&lt;create&gt;</a> would have succeeded in creating a Character.</p>
<p>A disadvantage of the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_transaction.html">&lt;transaction&gt;</a> is that database related exceptions may only be thrown at the end of the <code>transactions</code>. If you call code that handles db exceptions, it may not function as expected.</p>
 
<h2><a name="raw-sql"></a><a href="#raw-sql">Raw SQL<span class="anchor"> &#182;</span></a></h2><p>It is possible to execute <em>raw</em> SQL in Moya. This is generally discouraged, because it is possible to write SQL that doesn't work on all supported databases. Raw SQL is an option, however, if you need to access a feature of your database that Moya doesn't expose.</p>
<p>Use the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_sql.html">&lt;sql&gt;</a> tag to execute sql. The sql can be bound with parameters with the <code>bind</code> attribute, which should be a dict or dict-like object. Here is an example of a query with a bound parameter:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag xmlns">db:</span><span class="tag tagname">sql</span><span class="tag tagcontent">&nbsp;bind=</span><span class="attrib tag tagcontent">"name='John'"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"johns"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;*&nbsp;from&nbsp;moya_characters&nbsp;where&nbsp;name=:name;</div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/db:sql</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag tagcontent">&nbsp;obj=</span><span class="attrib tag tagcontent">"johns.fetch.all"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The query will be executed on the database and Moya will return a <em>results</em> object. See the <a class="tag" href="tags/httpmoyaprojectcomdb/tag_sql.html">&lt;sql&gt;</a> documentation for details of results objects.</p>
<aside>Note that the text in the &lt;sql&gt; tag does <em>not</em> support the usual substitution syntax (<b>${}</b>). This is intentional because otherwise it would be vulnerable to <a href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection</a> attacks.</aside> <h2><a name="database-expressions"></a><a href="#database-expressions">Database Expressions<span class="anchor"> &#182;</span></a></h2><p>Moya's <em>database expressions</em> are similar to the <em>context</em> expressions used elsewhere, but are transformed in to SQL by certain database tags. Since database expressions are evaluated by the database, they only support the range of operations you can do in SQL. This isn't really a restriction, because database expressions can still refer to any value on the context.</p>
<h3><a name="field-references"></a><a href="#field-references">Field References<span class="anchor"> &#182;</span></a></h3><p>A database expression must contain a <em>field reference</em> which consists of the model reference followed by a period and the name of the field. For example, <code>#Character.name</code> references the <code>name</code> field in the model <code>#Character</code>.</p>
<aside>You can't use the <em>docname</em> in a field reference, as the <code>#</code> is required.</aside><p>A field reference may also span relationships. For example, the following is valid:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">#Character.ship.name</div></pre><p>This would reference the <code>name</code> field from the <code>ship</code> foreign key of <code>#Character</code>.</p>
<h3><a name="literals"></a><a href="#literals">Literals<span class="anchor"> &#182;</span></a></h3><p>Database expressions may also contain literals &ndash; strings, numbers, and booleans &ndash; which are written in the same way as context expressions. For example, <code>'Hynerian'</code>, <code>42</code>, <code>yes</code>, <code>no</code>. A constant of <code>None</code> means the same as <code>NULL</code> in database expressions.</p>
<h3><a name="context-references"></a><a href="#context-references">Context References<span class="anchor"> &#182;</span></a></h3><p>Values in the context are also referenced in the same way as context expressions. For example, <code>foo</code>, <code>character.species</code>, <code>.request.path</code> are all valid in database expressions.</p>
<h3><a name="operators"></a><a href="#operators">Operators<span class="anchor"> &#182;</span></a></h3><p>Field references, literals and context references may be combined with some of the familiar operators. For example, the following expression would find all the <code>#Character</code> objects with a <code>name</code> field <em>equal to</em> <code>'John'</code>.</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1">#Character.name&nbsp;==&nbsp;'John'</div></pre><p>The operators <code>==</code>, <code>!=</code>, <code>lt</code>, <code>lte</code>, <code>gt</code>, <code>gte</code>, <code>^=</code>, <code>$=</code>, <code>in</code>, and <code>not in</code> all work like the equivalent operator in context expressions. Database expressions also support the SQL <a href="http://en.wikipedia.org/wiki/Where_(SQL)#LIKE">like</a> operator.</p>
<h3><a name="parenthesis"></a><a href="#parenthesis">Parenthesis<span class="anchor"> &#182;</span></a></h3><p>Database expression support parenthesis (brackets) in the same way as context expressions.</p>
<h3><a name="logic-operators"></a><a href="#logic-operators">Logic Operators<span class="anchor"> &#182;</span></a></h3><p>Parenthesis and the logic operators <code>and</code> and <code>or</code> work the same way as context expressions. For example, the following expression would match all <code>#Character</code> objects with the <code>name</code> field set to 'John' and <code>species</code> set to <code>'Human'</code>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1">(#Character.name&nbsp;==&nbsp;'John')&nbsp;and&nbsp;(#Character.species&nbsp;==&nbsp;'Human')</div></pre><h3><a name="related-fields"></a><a href="#related-fields">Related Fields<span class="anchor"> &#182;</span></a></h3><p>Database expressions may also refer to relationships with the same dotted notation. For example, the following db expression refers to the <code>name</code> attribute of foreign key object in #Character:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1">#Character.ship.name&nbsp;==&nbsp;'Moya'&nbsp;and&nbsp;#Character.species&nbsp;==&nbsp;'Human'</div></pre><h3><a name="modifiers"></a><a href="#modifiers">Modifiers<span class="anchor"> &#182;</span></a></h3><p>Database expressions also support the following <code>modifiers</code> which translate in to SQL. These are typically used when querying columns.</p>
<h4><a name="abs"></a><a href="#abs">abs:<span class="anchor"> &#182;</span></a></h4><p>Returns the <em>absolute</em> (with the negative sign) value of a number.</p>
<h4><a name="count"></a><a href="#count">count:<span class="anchor"> &#182;</span></a></h4><p>Returns the number of rows in a query.</p>
<h4><a name="sum"></a><a href="#sum">sum:<span class="anchor"> &#182;</span></a></h4><p>Sums the valus in a query.</p>
<h4><a name="min"></a><a href="#min">min:<span class="anchor"> &#182;</span></a></h4><p>Returns the minimum value in a query.</p>
<h4><a name="max"></a><a href="#max">max:<span class="anchor"> &#182;</span></a></h4><p>Returns the maximum value in a query.</p>
<h2><a name="field-reference"></a><a href="#field-reference">Field Reference<span class="anchor"> &#182;</span></a></h2><p>The following are the fields you may add to a <a class="tag" href="tags/httpmoyaprojectcomdb/tag_model.html">&lt;model&gt;</a>:</p>
<h3><a name="big-integer"></a><a href="#big-integer">&lt;big-integer&gt;<span class="anchor"> &#182;</span></a></h3><p>A <em>big</em> integer is a whole number in the range -9223372036854775808 to 9223372036854775807. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_big-integer.html">&lt;big-integer&gt;</a>.</p>
<h3><a name="boolean"></a><a href="#boolean">&lt;boolean&gt;<span class="anchor"> &#182;</span></a></h3><p>Stores a boolean value, which maps directly to a Moya boolean. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_boolean.html">&lt;boolean&gt;</a>.</p>
<h3><a name="date"></a><a href="#date">&lt;date&gt;<span class="anchor"> &#182;</span></a></h3><p>Stores a data (year, month, day). See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_date.html">&lt;date&gt;</a>.</p>
<h3><a name="float"></a><a href="#float">&lt;float&gt;<span class="anchor"> &#182;</span></a></h3><p>Stores a floating point value (number with fractional part). See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_float.html">&lt;float&gt;</a></p>
<h3><a name="foreign-key"></a><a href="#foreign-key">&lt;foreign-key&gt;<span class="anchor"> &#182;</span></a></h3><p>Stores a <em>foreign key</em> to another model. Foreign keys are a link from one table to another. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_foreign-key.html">&lt;foreign-key&gt;</a>.</p>
<h3><a name="integer"></a><a href="#integer">&lt;integer&gt;<span class="anchor"> &#182;</span></a></h3><p>Stores an integer (whole number). See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_integer.html">&lt;integer&gt;</a>.</p>
<h3><a name="many-to-many"></a><a href="#many-to-many">&lt;many-to-many&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a <em>many to many</em> relationship with another model. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_many-to-many.html">&lt;many-to-many&gt;</a>.</p>
<h3><a name="one-to-one"></a><a href="#one-to-one">&lt;one-to-one&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a <em>one to one</em> relationship with another model. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_one-to-one.html">&lt;one-to-one&gt;</a>.</p>
<h3><a name="relationship"></a><a href="#relationship">&lt;relationship&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a relationship with another model. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_relationship.html">&lt;relationship&gt;</a>.</p>
<h3><a name="small-integer"></a><a href="#small-integer">&lt;small-integer&gt;<span class="anchor"> &#182;</span></a></h3><p>Create a <em>small</em> integer (whole number). See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_small-integer.html">&lt;small-integer&gt;</a>.</p>
<h3><a name="string-map"></a><a href="#string-map">&lt;string-map&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a string map field. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_string-map.html">&lt;string-map&gt;</a></p>
<h3><a name="string"></a><a href="#string">&lt;string&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a string field. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_string.html">&lt;string&gt;</a></p>
<h3><a name="text"></a><a href="#text">&lt;text&gt;<span class="anchor"> &#182;</span></a></h3><p>Create a <em>text</em> field. A text field is similar to a string field, but without a restriction on the size. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_text.html">&lt;text&gt;</a>.</p>
<h3><a name="timezone"></a><a href="#timezone">&lt;timezone&gt;<span class="anchor"> &#182;</span></a></h3><p>Create a field to store a timezone. Used by the Moya Admin application. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_timezone.html">&lt;timezone&gt;</a>.</p>
<h3><a name="token"></a><a href="#token">&lt;token&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a field to store a randomly generated token. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_token.html">&lt;token&gt;</a>.</p>
<h3><a name="uuid"></a><a href="#uuid">&lt;uuid&gt;<span class="anchor"> &#182;</span></a></h3><p>Creates a field to store a <a href="http://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a>. See <a class="tag" href="tags/httpmoyaprojectcomdb/tag_uuid.html">&lt;uuid&gt;</a>.</p>
            

<div class="doc-nav">
    <ul class="pager">
        <li class="previous">
            <a href="content.html">&larr; 13. Content</a>
        </li>
        
        <li class="next">
            <a href="email.html">15. Email &rarr;</a>
        </li>
    </ul>
</div>


        </div>
        
        <div class="doctree-panel col-md-3">
        <ul>
    
    <li><a href="#database-settings">Database Settings</a><ul>
    
    <li><a href="#multiple-databases">Multiple Databases</a></li>
    
</ul></li>
    
    <li><a href="#supported-databases">Supported Databases</a><ul>
    
    <li><a href="#sqlite">SQLite</a></li>
    
    <li><a href="#mysql">MySQL</a></li>
    
    <li><a href="#postgressql">PostgresSQL</a></li>
    
    <li><a href="#oracle">Oracle</a></li>
    
</ul></li>
    
    <li><a href="#db-command">DB Command</a></li>
    
    <li><a href="#models">Models</a><ul>
    
    <li><a href="#fields">Fields</a></li>
    
    <li><a href="#model-references">Model References</a></li>
    
    <li><a href="#creating-model-objects">Creating Model Objects</a></li>
    
    <li><a href="#common-field-attributes">Common Field Attributes</a></li>
    
    <li><a href="#unique-fields">Unique Fields</a></li>
    
    <li><a href="#foreign-keys">Foreign Keys</a></li>
    
    <li><a href="#model-relationships">Model Relationships</a></li>
    
    <li><a href="#many-to-many">Many to Many</a></li>
    
</ul></li>
    
    <li><a href="#getting-model-objects">Getting Model Objects</a><ul>
    
    <li><a href="#getting-exactly-one">Getting Exactly One</a></li>
    
    <li><a href="#get-required">Get Required</a></li>
    
</ul></li>
    
    <li><a href="#modifying-model-objects">Modifying Model Objects</a></li>
    
    <li><a href="#queries">Queries</a><ul>
    
    <li><a href="#filtering-queries">Filtering Queries</a></li>
    
    <li><a href="#sorting-querysets">Sorting Querysets</a></li>
    
    <li><a href="#querying-columns">Querying Columns</a></li>
    
    <li><a href="#limiting-results">Limiting Results</a></li>
    
    <li><a href="#refining-queries">Refining Queries</a></li>
    
    <li><a href="#updating">Updating</a></li>
    
</ul></li>
    
    <li><a href="#deleting-model-objects">Deleting Model Objects</a></li>
    
    <li><a href="#transactions">Transactions</a></li>
    
    <li><a href="#raw-sql">Raw SQL</a></li>
    
    <li><a href="#database-expressions">Database Expressions</a><ul>
    
    <li><a href="#field-references">Field References</a></li>
    
    <li><a href="#literals">Literals</a></li>
    
    <li><a href="#context-references">Context References</a></li>
    
    <li><a href="#operators">Operators</a></li>
    
    <li><a href="#parenthesis">Parenthesis</a></li>
    
    <li><a href="#logic-operators">Logic Operators</a></li>
    
    <li><a href="#related-fields">Related Fields</a></li>
    
    <li><a href="#modifiers">Modifiers</a></li>
    
</ul></li>
    
    <li><a href="#field-reference">Field Reference</a><ul>
    
    <li><a href="#big-integer">&lt;big-integer&gt;</a></li>
    
    <li><a href="#boolean">&lt;boolean&gt;</a></li>
    
    <li><a href="#date">&lt;date&gt;</a></li>
    
    <li><a href="#float">&lt;float&gt;</a></li>
    
    <li><a href="#foreign-key">&lt;foreign-key&gt;</a></li>
    
    <li><a href="#integer">&lt;integer&gt;</a></li>
    
    <li><a href="#many-to-many">&lt;many-to-many&gt;</a></li>
    
    <li><a href="#one-to-one">&lt;one-to-one&gt;</a></li>
    
    <li><a href="#relationship">&lt;relationship&gt;</a></li>
    
    <li><a href="#small-integer">&lt;small-integer&gt;</a></li>
    
    <li><a href="#string-map">&lt;string-map&gt;</a></li>
    
    <li><a href="#string">&lt;string&gt;</a></li>
    
    <li><a href="#text">&lt;text&gt;</a></li>
    
    <li><a href="#timezone">&lt;timezone&gt;</a></li>
    
    <li><a href="#token">&lt;token&gt;</a></li>
    
    <li><a href="#uuid">&lt;uuid&gt;</a></li>
    
</ul></li>
    
</ul>
        </div>
        
    </div>
</div>

    <div id="push"></div>

    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">Moya is &copy; 2014 <a href="#">Moya Software Foundation</a>.</p>
      </div>
    </div>

    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.js"></script>


</body>

</html>