<!DOCTYPE html>
<!-- saved from url=(0065)http://twitter.github.io/bootstrap/examples/starter-template.html -->
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>URLs, Views and Middleware</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le styles -->
        <link href="assets/css/bootstrap.css" rel="stylesheet">
        <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
        <link href="assets/css/custom.css" rel="stylesheet">

        <style>
        
        </style>
    </head>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

  <body>
    <div id="wrap">
    <div id="main-nav" class="navbar navbar-default navbar-static-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".doc-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="index.html">Moya Documentation</a>
            </div>
            <nav class="collapse navbar-collapse doc-navbar-collapse" role="navigation">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="index.html">Reference</a>
                    </li>
                    <li >
                        <a href="tags/index.html">Tags</a>
                    </li>
                    <li >
                        <a href="tutorial.html">Tutorial</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    
<div class="container">
    <div class="row">
        <div class="doc-content col-md-9">
            

<div class="doc-nav">
    <ul class="pager">
        <li class="previous">
            <a href="templates.html">&larr; 11. Templates</a>
        </li>
        
        <li class="next">
            <a href="content.html">13. Content &rarr;</a>
        </li>
    </ul>
</div>


            <h1>URLs, Views and Middleware</h1>
            <p>The first thing Moya does when handling a request from the browser is to look at the requested URL and invoke the code in your project that will generate a response.</p>
<h2><a name="mountpoints"></a><a href="#mountpoints">Mountpoints<span class="anchor"> &#182;</span></a></h2><p>A library may expose a number of <em>mountpoints</em>, which are collections of URLS to be handled by the application. The URLs defined in a mountpoint are relative to the location where the application has been mounted. For instance, if a blog application was mounted on the path <code>/blog/</code>, it would be able to handle the path <code>/blog/posts/</code> and all other paths under <code>/blog/</code>.</p>
<p>Let's look at an example of a simple mountpoint:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">mounpoint</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Received&nbsp;a&nbsp;request&nbsp;for&nbsp;/</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="endtagname tag">/mountpoint</span><span class="tag">&gt;</span></div></pre><p>Assuming this was a part of a library called <code>moyaproject.sushifinder</code>, it would be mounted with the following lines inside the project's <a class="tag" href="tags/httpmoyaprojectcom/tag_server.html">&lt;server&gt;</a> as follows:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">install</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"sushifinder"</span><span class="tag tagcontent">&nbsp;lib=</span><span class="attrib tag tagcontent">"moyaproject.sushifinder"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">mount</span><span class="tag tagcontent">&nbsp;app=</span><span class="attrib tag tagcontent">"sushifinder"</span><span class="tag tagcontent">&nbsp;url=</span><span class="attrib tag tagcontent">"/sushifinder/"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>Now if you run the development server and visit <code>/sushifinder/</code>, you should find that a line of text will be echoed in the console. The page returned will be a <em>404 not found</em> response because although Moya has invoked the code inside the <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tag, it hasn't generated any kind of response. We'll cover the various methods of generating a response later in this chapter.</p>
<h3><a name="mountpoint-names"></a><a href="#mountpoint-names">Mountpoint Names<span class="anchor"> &#182;</span></a></h3><p>Libraries can have more than one mountpoint, which gives the project author the opportunity to chose a different path for each mountpoint, or to decide which mountpoints should be mounted at all. For instance a library may have a separate mountpoint for administration functionality and user views. The <code>name</code> attribute in <a class="tag" href="tags/httpmoyaprojectcom/tag_mountpoint.html">&lt;mountpoint&gt;</a> is used to name the mountpoint. This name is used by the <a class="tag" href="tags/httpmoyaprojectcom/tag_mount.html">&lt;mount&gt;</a> tag to tell Moya which mountpoint to use.</p>
<p>Let's demonstrate this by adding a second mountpoint:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">mounpoint</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Received&nbsp;a&nbsp;request&nbsp;for&nbsp;/</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="endtagname tag">/mountpoint</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="tag tagname">mountpoint</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"shop"</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/"</span><span class="tag">&gt;</span></div><a name="line8"></a><div class="line line-8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Handling&nbsp;Shop</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line9"></a><div class="line line-9">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line10"></a><div class="line line-10"></span><span class="tag">&lt;</span><span class="endtagname tag">/mountpoint</span><span class="tag">&gt;</span></div></pre><p>Here we have added a second mountpoint with a name of <code>'shop'</code>. We can mount this new mountpoint by adding the following to the <a class="tag" href="tags/httpmoyaprojectcom/tag_server.html">&lt;server&gt;</a> tag as follows:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">install</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"sushifinder"</span><span class="tag tagcontent">&nbsp;lib=</span><span class="attrib tag tagcontent">"moyaproject.sushifinder"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">mount</span><span class="tag tagcontent">&nbsp;app=</span><span class="attrib tag tagcontent">"sushifinder"</span><span class="tag tagcontent">&nbsp;url=</span><span class="attrib tag tagcontent">"/sushifinder/"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="tag tagname">mount</span><span class="tag tagcontent">&nbsp;app=</span><span class="attrib tag tagcontent">"sushifinder"</span><span class="tag tagcontent">&nbsp;url=</span><span class="attrib tag tagcontent">"/checkout/"</span><span class="tag tagcontent">&nbsp;mountpoint=</span><span class="attrib tag tagcontent">"shop"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The second mountpoint has been mounted on <code>/checkout/</code>, so visiting that URL will echo a different message to the console.</p>
<h3><a name="default-mountpoint"></a><a href="#default-mountpoint">Default Mountpoint<span class="anchor"> &#182;</span></a></h3><p>The default value for the <code>name</code> attribute on <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> is <code>'main'</code>, which is also the default value for <code>mountpoint</code> in the <a class="tag" href="tags/httpmoyaprojectcom/tag_mount.html">&lt;mount&gt;</a> tag. This is why we didn't need the <code>name</code> attribute to mount the first mountpoint we created.</p>
<h3><a name="mount-shortcut"></a><a href="#mount-shortcut">Mount Shortcut<span class="anchor"> &#182;</span></a></h3><p>It is very common to mount the default mountpoint immediately after installing the application. Because of this, Moya adds a shortcut to the <a class="tag" href="tags/httpmoyaprojectcom/tag_install.html">&lt;install&gt;</a> which will mount the default mountpoint. If you set the <code>mount</code> attribute, Moya will mount the default mountpoint on that path. Here's how we would use this to simplify the code in <a class="tag" href="tags/httpmoyaprojectcom/tag_server.html">&lt;server&gt;</a>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">install</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"sushifinder"</span><span class="tag tagcontent">&nbsp;lib=</span><span class="attrib tag tagcontent">"moyaproject.sushifinder"</span><span class="tag tagcontent">&nbsp;mount=</span><span class="attrib tag tagcontent">"/sushifinder/"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>This only works for the default mointpoint (named <code>'main'</code>). We would still need <a class="tag" href="tags/httpmoyaprojectcom/tag_mount.html">&lt;mount&gt;</a> tags for other mountpoints.</p>
<h2><a name="url-routes"></a><a href="#url-routes">URL Routes<span class="anchor"> &#182;</span></a></h2><p>The code in a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tag is invoked if it matches the supplied <em>route</em>, specified with the <code>route</code> attribute. A route can be a simple URL, if it is designed to handle a single page, or can contain a <em>wildcard</em> in curly brackets (<code>{}</code>) if it is to match a number of URLs in a particular format. Here's an example of a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> with a wildcard route:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/list/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Listing&nbsp;product&nbsp;</span><span class="sub">$</span><span class="braced sub">{url.product}</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>When moya sees text enclosed in curly brackets (<code>{</code> and <code>}</code>) it will match that part with any text in the requested URL. For instance, if the above URL was mounted in the sushifinder application, it would match <code>/sushifinder/list/tunaroll/</code> and <code>/suhifinder/list/sake-nigiri/</code>. Moya also extracts the matched text and stores it in a dictionary called <code>url</code> (the text in the curly brackets is used as the key). So with the previous examples URLs, <code>url.product</code> would be <code>'tunaroll'</code> or <code>'sake-nigiri'</code>. Moya also stores a copy of the <code>url</code> dictionary in the root of the context, so that it is always accessible as <code>.url</code>.</p>
<h3><a name="route-types"></a><a href="#route-types">Route Types<span class="anchor"> &#182;</span></a></h3><p>The route matching syntax also supports specifying the format of the text that matches. For instance, let's say we have a URL route as follows:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">/blog/{year}/{month}/</div></pre><p>This will match <code>/blog/2014/7/</code>, but it will also match <code>/blog/some-text/not-a-month/</code>, which might cause problems if we attempt to use text where we expect a number. You can tell Moya to only match a particular set of characters by specifying the type followed by a colon then the name. For example, we can re-write the above URL as the following:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">/blog/{integer:year}/{integer:month}/</div></pre><p>The <code>integer:</code> prefix tells Moya to match only valid numbers. The URLs containing text would now <em>not</em> match and Moya would return a '404 not found' page (assuming they match no other URL that is).</p>
<div class="alert alert-warning"><strong>NOTE</strong> Note that, the <code>integer:</code> prefix only tells Moya to match digits, the value of <code>url.year</code> and <code>url.month</code> will still be strings. If you do need integers values, you can convert the strings to a number in an expression with the <code>int:</code> modifier.</div><p>The following is a list of the route match types:</p>
<dl class="dl-horizontal"><dt>alpha</dt>
<dd>
Matches alpha numeric characters (letters and numbers).
</dd><dt>slug</dt>
<dd>
Matches characters suitable for a <em>slug</em> (letters, numbers, underscore and hyphen).
</dd><dt>integer</dt>
<dd>
Matches a valid integer. May be negative.
</dd><dt>float</dt>
<dd>
Matches a floating point number. May be negative.
</dd><dt>posinteger</dt>
<dd>
Matches a positive integer (a number greater than 0).
</dd><dt>posfloat</dt>
<dd>
Matches a positive floating point number (greater than 0).
</dd></dl><h3><a name="matching-paths"></a><a href="#matching-paths">Matching Paths<span class="anchor"> &#182;</span></a></h3><p>Normally Moya will only match only text between slashes. Occasionally it may be necessary to match text that includes forward slashes (typically to match paths). You can tell Moya to do this in the path matching syntax by prefixing it with an asterisk. Here's an example:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">/serve/{*path}</div></pre><p>This will match any URL that starts with <code>/serve/</code>, and extract the remainder of the URL. For instance, it will match the URL <code>/serve/media/images/sushi.png</code>, and <code>url.path</code> with contain <code>media/images/sushi.png</code>.</p>
<h3><a name="matching-methods"></a><a href="#matching-methods">Matching Methods<span class="anchor"> &#182;</span></a></h3><p>You can write URLs which match only particular <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">http methods</a>. The default for a view is to match both GET and POST requests, but it is possible to match any combination of methods by specifying a comma separated list in the <code>methods</code> attribute of the <a class="tag" href="tags/httpmoyaprojectcom/tag_view.html">&lt;view&gt;</a>. Here's how we can define two <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tags for the same route, one will handle GET requests, and the other will handle POST requests:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag tagcontent">&nbsp;methods=</span><span class="attrib tag tagcontent">"GET"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>render&nbsp;a&nbsp;product&nbsp;page</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag tagcontent">&nbsp;methods=</span><span class="attrib tag tagcontent">"POST"</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>handle&nbsp;a&nbsp;form&nbsp;on&nbsp;the&nbsp;product&nbsp;page</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>Separate handlers for GET and POST requests can be convenient. The default, however, is to handle both GET and POST in the same <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a>. The value <code>.request.method</code> contains the current method, so you could use the expression <code>.request.method=='POST'</code> to detect a post request. Alternatively, the <a class="tag" href="tags/httpmoyaprojectcom/tag_if-post.html">&lt;if-post&gt;</a> tag will execute a block of code if the current request is a POST request.</p>
<h3><a name="naming-routes"></a><a href="#naming-routes">Naming Routes<span class="anchor"> &#182;</span></a></h3><p>When you define a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a>, you can supply an optional <code>name</code> parameter which you can use to <em>look up</em> the URL. This is important because the final URL can change if the application is mounted in a different location. If we were to hard-code that URL (such as in <a href="templates.html" title="Templates">template</a> code) we would have to manually update every point where that URL was used if the application was mounted in a different location. For example, lets look at a URL in our fictitious sushifinder application:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/reviews/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Product&nbsp;reviews</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>If we mount the app on <code>/sushifinder/</code> then the final URL for the page would be <code>/sushifinder/reviews/</code>. We could use this URL in a template, and it would appear to work just fine. A problem arises if we mount that application in a different location; all of a sudden any links to that page are broken and will likely return a <code>404 Not Found</code> response. The solution is to first give the URL a name. For example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/reviews/"</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"reviews_index"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Product&nbsp;reviews</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>We can now replace any references to that URL in our template with a <a href="templates.html#url" title="Templates">{% url %}</a> template tag, as follows:</p>
<pre class="moya-console format-moyatemplate"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">a</span><span class="tag tagcontent">&nbsp;href=</span><span class="attrib tag tagcontent">"</span><span class="attrib tag tagcontent templatetag">{%&nbsp;url&nbsp;'reviews_index'&nbsp;%}</span><span class="attrib tag tagcontent">"</span><span class="tag">&gt;</span>Sushi&nbsp;Reviews</span><span class="tag">&lt;</span><span class="endtagname tag">/a</span><span class="tag">&gt;</span></div></pre><p>Now, if the final URL changes, The links to it within templates will update automatically. You may do the same thing in Moya code with the <a class="tag" href="tags/httpmoyaprojectcom/tag_get-url.html">&lt;get-url&gt;</a> tag as follows:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">get-url</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"reviews_index"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"reviews_url"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>The&nbsp;URL&nbsp;for&nbsp;reviews&nbsp;is&nbsp;</span><span class="sub">$</span><span class="braced sub">{reviews_url}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>As we've seen, some URLs may contain parameters. Moya needs these extra parameters in order to generate the full URL. The following is an example of a URL with a parameter:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/reviews/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"reviews_product"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Product&nbsp;reviews</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>The above <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> actually defines a number of URLs, depending on the value of <code>product</code>. If we want to link to a particular product, we must let Moya know what that product is. Here's how we would link to a product called <code>nigiri</code> in a template:</p>
<pre class="moya-console format-moyatemplate"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">a</span><span class="tag tagcontent">&nbsp;href=</span><span class="attrib tag tagcontent">"</span><span class="attrib tag tagcontent templatetag">{%&nbsp;url&nbsp;'reviews_product'&nbsp;with&nbsp;product='nigiri'&nbsp;%}</span><span class="attrib tag tagcontent">"</span><span class="tag">&gt;</span>Go&nbsp;to&nbsp;Nigiri&nbsp;Reviews</span><span class="tag">&lt;</span><span class="endtagname tag">/a</span><span class="tag">&gt;</span></div></pre><p>In Moya code we can generate the same URL by passing the URL parameters to <a class="tag" href="tags/httpmoyaprojectcom/tag_get-url.html">&lt;get-url&gt;</a> as a LET value. Here's how:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">get-url</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"reviews_product"</span><span class="tag tagcontent">&nbsp;let:product=</span><span class="attrib tag tagcontent">"nigiri"</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"nigiri_reviews_url"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>The&nbsp;URL&nbsp;for&nbsp;nigiri&nbsp;reviews&nbsp;is&nbsp;</span><span class="sub">$</span><span class="braced sub">{nigiri_reviews_url}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><h3><a name="urls-container"></a><a href="#urls-container">URLS Container<span class="anchor"> &#182;</span></a></h3><p>An alternative to <a class="tag" href="tags/httpmoyaprojectcom/tag_get-url.html">&lt;get-url&gt;</a> for looking up URLs is the <em>URL container</em> object in the context (<code>.urls</code>). This object contains all URLs in the project in a hierarchical format. For instance <code>.urls.auth.login</code> will return a URL to the login page in <code>auth</code> application.</p>
<aside>The URL container is accessible from templates as well.</aside><p>For URLs that contain parameters you will need to append values for those parameters in parenthesis. For example, the following gets the About page from the Pages application:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>About&nbsp;URL&nbsp;is:&nbsp;</span><span class="sub">$</span><span class="braced sub">{.urls.pages.showpage(pagename='about')}</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span></div></pre><p>The <code>(pagename='about')</code> syntax supplies the missing parameters. Without a parameter for <code>pagename</code> Moya will be unable to generate a working URL, and will raise an error.</p>
<p>The URLs container object may be explored via the debugger. Probably the simplest way to do this would be to run the server with the <code>--breakpoint</code> switch, as follows:</p>
<pre class="moya-console format-"><a name="line1"></a><div class="line line-1">$&nbsp;moya&nbsp;runserver&nbsp;--breakpoint</div></pre><p>Then load any page in the browser (e.g. <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>). Moya will immediately drop in to the debugger. If you inspect the value <code>.urls</code>, you should see a table of mountpoints in each application. If you inspect a mountpoint (e.g. <code>.urls.pages</code>) you will see a table of URLs.</p>
<h2><a name="generating-a-response"></a><a href="#generating-a-response">Generating a Response<span class="anchor"> &#182;</span></a></h2><p>We've seen how invoke code that matches a particular URL, but so far we've only written to the console when a URL is requested. To build a real web application we will need to generate a <em>response</em>, which will typically be a page of <a href="http://en.wikipedia.org/wiki/Html">HTML</a>.</p>
<p>When Moya executes the code inside a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a>, it treats the contents as a macro (or <em>function</em>). If we return (with <a class="tag" href="tags/httpmoyaprojectcom/tag_return.html">&lt;return&gt;</a>) something from a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tag, Moya will convert that return value to HTML and serve it to the browser. Here's an example of returning HTML from a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tag:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="comment">&lt;!--&nbsp;This&nbsp;should&nbsp;be&nbsp;inside&nbsp;a&nbsp;mountpoint&nbsp;tag&nbsp;--&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/test/"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">html</span><span class="tag">&gt;</span><span class="tag cdata">&lt;</span><span class="tag tagcontent cdata">![CDATA[</span></div><a name="line5"></a><div class="line line-5"><span class="tag tagcontent cdata">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1</span><span class="tag cdata">&gt;</span><span class="cdata">Hello,&nbsp;World!</span><span class="tag cdata">&lt;</span><span class="endtagname tag cdata">/h1</span><span class="tag cdata">&gt;</span><span class="cdata"></span></div><a name="line6"></a><div class="line line-6"><span class="cdata">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]&gt;</span><span class="tag">&lt;</span><span class="endtagname tag">/html</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/return</span><span class="tag">&gt;</span></div><a name="line8"></a><div class="line line-8"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><aside>Note the user of <a href="http://en.wikipedia.org/wiki/Cdata">CDATA</a> in the above lising. This tells the XML parser to treat the contents as text and not as tags (so we can mix HTML with XML).</aside><p>Don't worry if this looks clumsy to you. Returning HTML like this is rarely done in a real project &ndash; there are much better ways of generating a response which we will cover next.</p>
<h3><a name="rendering-templates"></a><a href="#rendering-templates">Rendering Templates<span class="anchor"> &#182;</span></a></h3><p>A more convenient (and powerful) way of generating a response is to render a <a href="templates.html" title="Templates">template</a>, which is a text file with a special markup. We can do this with the <a class="tag" href="tags/httpmoyaprojectcom/tag_render-template.html">&lt;render-template&gt;</a> tag. Here's an example of generating a page of HTML from a template:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/test2/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">render-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"/hello.html"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'World'"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/return</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>Here is the template for use with the above code (saved as <code>"hello.html"</code> in the templates directory):</p>
<pre class="moya-console format-moyatemplate"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">h1</span><span class="tag">&gt;</span>Hello,&nbsp;</span><span class="sub">${name}</span>!</span><span class="tag">&lt;</span><span class="endtagname tag">/h1</span><span class="tag">&gt;</span></div></pre><p>Now when you request <code>/test2/</code>, Moya will <em>render</em> <code>"hello.html"</code> with the value for <code>name</code> replaced with the text we supplied to the <a class="tag" href="tags/httpmoyaprojectcom/tag_render-template.html">&lt;render-template&gt;</a> tag. The resulting string is then served as a standard HTML response. See <a href="templates.html">Templates</a> for more information on writing templates.</p>
<p>In the preceding example we returned a string which Moya used to generate the response. Moya also offers the <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-template.html">&lt;serve-template&gt;</a> tag which renders a template and immediately returns the response, negating the need to return a value. The following code is equivalent to the preceding example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/test3/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"/hello.html"</span><span class="tag tagcontent">&nbsp;let:name=</span><span class="attrib tag tagcontent">"'World'"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag">&gt;</span>Moya&nbsp;will&nbsp;never&nbsp;get&nbsp;here</span><span class="tag">&lt;</span><span class="endtagname tag">/echo</span><span class="tag">&gt;</span>&nbsp;</span><span class="comment">&lt;!--&nbsp;see&nbsp;below&nbsp;--&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>Note that because the <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-template.html">&lt;serve-template&gt;</a> generates and returns a response, the following <a class="tag" href="tags/httpmoyaprojectcom/tag_echo.html">&lt;echo&gt;</a> line never gets called. This is generally useful because it is rare to need to do any more processing once you have a response.</p>
<p>The <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-template.html">&lt;serve-template&gt;</a> has an optional parameter <code>withscope</code> which tells Moya to use the current local variables (anything variables created in the URL) when generating the template. This negates the need to specify the template data explicitly, which can save some time. Here's an example of rendering and serving a template with local variables, equivalent to the previous example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/test4/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">str</span><span class="tag tagcontent">&nbsp;dst=</span><span class="attrib tag tagcontent">"name"</span><span class="tag">&gt;</span>World</span><span class="tag">&lt;</span><span class="endtagname tag">/str</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"/hello.html"</span><span class="tag tagcontent">&nbsp;withscope=</span><span class="attrib tag tagcontent">"yes"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>When Moya renders <code>hello.html</code>, the template will have access to the <code>name</code> variable even though it wasn't explicitly specified. Serving templates with the current scope can save some time, but it is not always desirable to expose everything to the templates in this way. If you have something in the local scope that you <em>don't</em> want to be used in the template, it may be a better idea to explicitly list the variables you do want.</p>
<h3><a name="serving-files"></a><a href="#serving-files">Serving Files<span class="anchor"> &#182;</span></a></h3><p>The <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-file.html">&lt;serve-file&gt;</a> tag may be used to serve a static file from any <a href="project#filesystem">filesystem</a> in the project. Here's an example of using <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-file.html">&lt;serve-file&gt;</a> to serve files from a filesystem called <code>photos</code>:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/photos/</span><span class="braced attrib tag tagcontent">{*path}</span><span class="attrib tag tagcontent">"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-file</span><span class="tag tagcontent">&nbsp;fs=</span><span class="attrib tag tagcontent">"photos"</span><span class="tag tagcontent">&nbsp;path=</span><span class="attrib tag tagcontent">"</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{url.path}</span><span class="attrib tag tagcontent">"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>Note the asterisk in the url route, which tells Moya to match the remainder of the path, including forward slashes. When Moya receive a request for a URL beginning with <code>/photos/</code>, such as <code>/photos/menu/nigiri.jpg</code>, the portion after <code>/photo/</code> is stored in <code>url.path</code>. This result is the <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-file.html">&lt;serve-file&gt;</a> tag being called with a path of <code>menu/nigiri.jpg</code>. If that file exists in the <code>photos</code> filesystem it will be served, otherwise Moya will return a <code>404 Not Found</code> response.</p>
<div class="alert alert-warning"><strong>NOTE</strong> The builtin application <a href="static.html" title="Moya Static">Moya Static</a> will also serve static files. It can also generate index pages.</div><h3><a name="redirects"></a><a href="#redirects">Redirects<span class="anchor"> &#182;</span></a></h3><p>Moya can serve a <em>redirect</em> response which tells the browser to request a new URL. There are two tags that do this; <a class="tag" href="tags/httpmoyaprojectcom/tag_redirect-to.html">&lt;redirect-to&gt;</a> which redirects to a relative path or a new URL entirely, and <a class="tag" href="tags/httpmoyaprojectcom/tag_redirect.html">&lt;redirect&gt;</a> which redirects to a new <a href="urls.html#naming-routes" title="URLs, Views and Middleware">named url</a>. Here's an example of redirecting to a new URL outside of the project:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="comment">&lt;!--&nbsp;can't&nbsp;sell&nbsp;sake&nbsp;to&nbsp;kids&nbsp;--&gt;</span></div><a name="line2"></a><div class="line line-2"></span><span class="tag">&lt;</span><span class="tag tagname">redirect-to</span><span class="tag tagcontent">&nbsp;url=</span><span class="attrib tag tagcontent">"http://google.com"</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"not&nbsp;.request.POST.over_eighteen"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>The <a class="tag" href="tags/httpmoyaprojectcom/tag_redirect.html">&lt;redirect&gt;</a> tag is similar, but requires a named URL route in the project:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">redirect</span><span class="tag tagcontent">&nbsp;name=</span><span class="attrib tag tagcontent">"out_of_stock"</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"product.stock&nbsp;==&nbsp;0"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div></pre><p>A similar concept to redirecting is <a href="urls.html#rewrites" title="URLs, Views and Middleware">rewriting</a>, which can serve content from a different URL <em>without</em> changing the URL in the browser's location bar.</p>
<h3><a name="not-found"></a><a href="#not-found">Not Found<span class="anchor"> &#182;</span></a></h3><p>You can serve a <code>404 Not Found</code> response with the <a class="tag" href="tags/httpmoyaprojectcom/tag_not-found.html">&lt;not-found&gt;</a> tag. Moya will generate a 404 automatically if no <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> handled the current request, but sometimes you want to explicitly generate the not found response if the URL refers to a resource that is missing. Here's an example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">not-found</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"url.product&nbsp;not&nbsp;in&nbsp;['nigiri',&nbsp;tuna-roll',&nbsp;'fugu']"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag tagcontent">&nbsp;let:product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>The <a class="tag" href="tags/httpmoyaprojectcom/tag_not-found.html">&lt;not-found&gt;</a> tag in the above example checks that the value of <code>url.product</code> equals one of three products. If it doesn't, Moya will serve a not found response.</p>
<p>Not that because a not found response is a valid response, Moya will not check any more URLs for the current request after a <a class="tag" href="tags/httpmoyaprojectcom/tag_not-found.html">&lt;not-found&gt;</a> tag. If you want skip processing the current <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a>, but still look for other potential URL matches, you can use the <a class="tag" href="tags/httpmoyaprojectcom/tag_done.html">&lt;done&gt;</a> tag.</p>
<h3><a name="forbidden"></a><a href="#forbidden">Forbidden<span class="anchor"> &#182;</span></a></h3><p>Moya can serve a <code>403 forbidden</code> response, which tells the browser that the current user may not access that URL or resource. For example, the following URL generates a forbidden response if the user is not currently logged in:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/order/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">forbidden</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"not&nbsp;.user"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><h3><a name="other-responses"></a><a href="#other-responses">Other Responses<span class="anchor"> &#182;</span></a></h3><p>For more control over the type of response generated you can use the <a class="tag" href="tags/httpmoyaprojectcom/tag_response.html">&lt;response&gt;</a> tag, which constructs a response object. Return a response object from a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> to serve it. Here's an example of generating a <a href="http://en.wikipedia.org/wiki/Http_status_codes#4xx_Client_Error">418 I'm a teapot</a> response:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/serve/tea/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">response</span><span class="tag tagcontent">&nbsp;status=</span><span class="attrib tag tagcontent">"im_a_teapot"</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Short&nbsp;and&nbsp;stout.</div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/response</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/return</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><div class="alert alert-warning"><strong>NOTE</strong> We're still looking for a Linux powered Teapot to test this on.</div><h2><a name="handlers"></a><a href="#handlers">Handlers<span class="anchor"> &#182;</span></a></h2><p>When Moya is unable to return content due to an error or a 'not found' response, it will search the mountpoints for a <em>handler</em> for that URL. This is so that your project has an opportunity to generate a custom response which would otherwise result in Moya serving default content.</p>
<p>All that is required to define a custom handler is to set the <code>handler</code> attribute on a <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> to the <a href="codes.html" title="Status Codes">HTTP status code</a> you want to handle. Here's how we might write a handler for a not found response:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">not-found</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"url.product&nbsp;not&nbsp;in&nbsp;['nigiri',&nbsp;tuna-roll',&nbsp;'fugu']"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag tagcontent">&nbsp;let:product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag tagcontent">&nbsp;handler=</span><span class="attrib tag tagcontent">"not_found"</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product_not_found.html"</span><span class="tag tagcontent">&nbsp;let:product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>The first <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> we have seen before; it will be invoked when the user requests <code>/sushifinder/product/unagi/</code>, but because it is <em>not</em> one of the three products it will generate a <code>404 not found</code> response. Normally this will generate a standard response, but because the second <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> is a handler for <code>not_found</code>, Moya will invoke that code, which serves a template called <code>"product_not_found.html"</code>. This other template could generate a more specific message for the user, or possibly offer a search box so the user may find other products.</p>
<h3><a name="default-handlers"></a><a href="#default-handlers">Default Handlers<span class="anchor"> &#182;</span></a></h3><p>If your project doesn't explicitly define a handler for a status code, Moya will attempt to render and serve a template called <code>&lt;status code&gt;.html</code>. For example, if your project generates a <code>404 not found</code> response or there is no matching <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a>, Moya will serve the template <code>404.html</code> in the root of your templates directory.</p>
<p>It is recommended that you at least define templates <code>404.html</code> (not found) and <code>500.html</code> (internal error). If they are not present, Moya will generate a rather dull looking page without your site's branding.</p>
<p>Note that if you are running the server with <a href="project.html#project-settings" title="Building a Project">debug enabled</a> then the Moya Debug application will supply templates for <code>404.html</code> and <code>500.html</code>. These templates will generate a helpful response when you are debugging, but you will need to disable debug mode if you want to test your versions of these templates.</p>
<h2><a name="rewrites"></a><a href="#rewrites">Rewrites<span class="anchor"> &#182;</span></a></h2><p>You can change the URL that Moya is currently processing with the <a class="tag" href="tags/httpmoyaprojectcom/tag_rewrite.html">&lt;rewrite&gt;</a> tag which rewrites to a named url in the project, or with <a class="tag" href="tags/httpmoyaprojectcom/tag_rewrite-to.html">&lt;rewrite-to&gt;</a> which can rewrite to an abitrary URL. When Moya sees either of these tags it will stop processing further URLs and start again with the new URL. This is a similar concept to <a href="urls.html#redirects" title="URLs, Views and Middleware">redirects</a> &ndash; the difference is that Moya will serve the content for the new URL in the current request <em>without</em> changing the URL in the user's browser.</p>
<p>Let's look at an example of where you might use a rewrite. If your site has been translated in to a number of languages, one way of switching between languages would be to have the languages code as the first component of the URL. For example <code>/fr/about/</code> should show the about page in French. But we also want <code>/about/</code> to show the default language of English. Here's how we could do that with the <a class="tag" href="tags/httpmoyaprojectcom/tag_rewrite-to.html">&lt;rewrite-to&gt;</a> tag:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/</span><span class="braced attrib tag tagcontent">{lang}</span><span class="attrib tag tagcontent">/</span><span class="braced attrib tag tagcontent">{*path}</span><span class="attrib tag tagcontent">"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">if</span><span class="tag tagcontent">&nbsp;test=</span><span class="attrib tag tagcontent">"lang&nbsp;in&nbsp;['en',&nbsp;'fr',&nbsp;'es']"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">set-language</span><span class="tag tagcontent">&nbsp;language=</span><span class="attrib tag tagcontent">"</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{lang}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">rewrite-to</span><span class="tag tagcontent">&nbsp;path=</span><span class="attrib tag tagcontent">"</span><span class="attrib tag tagcontent sub">$</span><span class="braced attrib tag tagcontent sub">{path}</span><span class="attrib tag tagcontent">"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/if</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div></pre><p>This <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tag matches the first component of the a URL. If the first component is one of the supported languages, then the enclosed code will set the language and rewrite the URL to the remainder of the path. Otherwise the URL is served as normal.</p>
<aside>Rewriting the URL has its uses, but a <em>redirect</em> is a generally more appropriate.</aside><h2><a name="views"></a><a href="#views">Views<span class="anchor"> &#182;</span></a></h2><p>We've seen that Moya runs the code <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tags which match the requested URL. It is also possible to explicitly set a special callable tag called a <em>view</em> which is responsible for generating a response. Typically code inside <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> tags is reserved for simple things like permissions checks and redirects, the job of generating a page of HTML is delegated to a <a class="tag" href="tags/httpmoyaprojectcom/tag_view.html">&lt;view&gt;</a> tag. Let's look at how we might modify a previous example to use a view:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">mountpoint</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag tagcontent">&nbsp;view=</span><span class="attrib tag tagcontent">"#view.product"</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">not-found</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"url.product&nbsp;not&nbsp;in&nbsp;['nigiri',&nbsp;tuna-roll',&nbsp;'fugu']"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="tag tagname">mountpoint</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"><br></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="tag tagname">view</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"view.product"</span><span class="tag">&gt;</span></div><a name="line8"></a><div class="line line-8">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">serve-template</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag tagcontent">&nbsp;let:product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line9"></a><div class="line line-9"></span><span class="tag">&lt;</span><span class="endtagname tag">/view</span><span class="tag">&gt;</span></div></pre><p>Here we can see that the <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> contains a conditional <a class="tag" href="tags/httpmoyaprojectcom/tag_not-found.html">&lt;not-found&gt;</a> tag, which will return a <code>not found</code> response <em>if</em> the product in the url is not one of three products. Otherwise, the view specified in the <code>view</code> attribute will be invoked.</p>
<p>The <code>view</code> attribute of <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> is an <a href="moyacode.html#element-references" title="Moya Code">element reference</a>. It is set to <code>#view.product</code>, which tells Moya to use the view with a libname of <code>view.product</code> in the current library. The <code>view.</code> part of the libname is a convention &ndash; it helps to keep your project organized if you name elements according to their type.</p>
<p>Moya invokes the code inside the <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a> first. If that code doesn't generate a response, it will call the code inside the <a class="tag" href="tags/httpmoyaprojectcom/tag_view.html">&lt;view&gt;</a>. Views have a number of advantages which we will cover next.</p>
<h3><a name="template-views"></a><a href="#template-views">Template Views<span class="anchor"> &#182;</span></a></h3><p>Because rendering a template is by far the most common thing you will do in a view, the <a class="tag" href="tags/httpmoyaprojectcom/tag_view.html">&lt;view&gt;</a> tag has a shortcut for this. You can specify a <code>template</code> attribute on the view. This template will be rendered with any variables created in the current scope (i.e. within the view itself). Here's how we could re-write the view to take advantage of this:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">view</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"view.product"</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">let</span><span class="tag tagcontent">&nbsp;product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/view</span><span class="tag">&gt;</span></div></pre><p>When the above view runs, Moya renders <code>product.html</code> with the current scope (the value for <code>product</code> in this example). This negates the need for the explicit <a class="tag" href="tags/httpmoyaprojectcom/tag_serve-template.html">&lt;serve-template&gt;</a> tag.</p>
<h3><a name="explicit-template-data"></a><a href="#explicit-template-data">Explicit Template Data<span class="anchor"> &#182;</span></a></h3><p>If you <em>don't</em> want to pass everything in the current scope to the template (there may be intermediate data you don't want the template designer to reference), you can explicitly return the data which you want to render in the template. Here's how to do that:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">view</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"view.product"</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">dict</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">let</span><span class="tag tagcontent">&nbsp;product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/dict</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/return</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"></span><span class="tag">&lt;</span><span class="endtagname tag">/view</span><span class="tag">&gt;</span></div></pre><p>Which method you use depends largely on how complex the view is. In a real project some views may do several database queries and calculations, resulting in a number of intermediate values that you <em>don't</em> want to be available to the template. For these, you should use the more explicit way of specifying template data. Leave the implicit template rendering of the scope for simpler views.</p>
<p>If you find the preceding example a little verbose, you can use <a class="tag" href="tags/httpmoyaprojectcom/tag_return-dict.html">&lt;return-dict&gt;</a> which is a shortcut that returns a dictionary. Here's an example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">view</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"view.product"</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return-dict</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">let</span><span class="tag tagcontent">&nbsp;product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/return-dict</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5"></span><span class="tag">&lt;</span><span class="endtagname tag">/view</span><span class="tag">&gt;</span></div></pre><p>You can save on typing even further with the LET extension:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">view</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"view.product"</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return-dict</span><span class="tag tagcontent">&nbsp;let:product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3"></span><span class="tag">&lt;</span><span class="endtagname tag">/view</span><span class="tag">&gt;</span></div></pre><p>Another keyboard saving option is the <a class="tag" href="tags/httpmoyaprojectcom/tag_return-scope.html">&lt;return-scope&gt;</a>, which parses a list of values to return from the scope. Here's an example:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">view</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"view.product"</span><span class="tag tagcontent">&nbsp;template=</span><span class="attrib tag tagcontent">"product.html"</span><span class="tag tagcontent">"</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">let</span><span class="tag tagcontent">&nbsp;product=</span><span class="attrib tag tagcontent">"url.product"</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">return-scope</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;product</div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/return-scope</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="endtagname tag">/view</span><span class="tag">&gt;</span></div></pre><p>This is probably the best choice for complex views which calculate a lot of data.</p>
<h3><a name="content-views"></a><a href="#content-views">Content Views<span class="anchor"> &#182;</span></a></h3><p>There is a another attribute which you can specify on a <a class="tag" href="tags/httpmoyaprojectcom/tag_view.html">&lt;view&gt;</a>, called <code>content</code>. This renders a content element rather than a template. See <a href="content.html">Content</a> for how to work with content elements.</p>
<h2><a name="middleware"></a><a href="#middleware">Middleware<span class="anchor"> &#182;</span></a></h2><p>Middleware is code that runs outside of the usual URL handling process in order to implement features that should be applicable to all requests. This is how the <a href="auth.html" title="Moya Auth (users and permissions)">Moya Auth</a> library adds user and permission information to the context.</p>
<aside>Most libraries won't make use of middleware; it is generally used as a way of implementing advanced features.</aside><p>To create middleware, add a <a class="tag" href="tags/httpmoyaprojectcom/tag_middleware.html">&lt;middleware&gt;</a> tag inside your <a class="tag" href="tags/httpmoyaprojectcom/tag_mountpoint.html">&lt;mountpoint&gt;</a>. The <a class="tag" href="tags/httpmoyaprojectcom/tag_middleware.html">&lt;middleware&gt;</a> tag takes similar attributes to <a class="tag" href="tags/httpmoyaprojectcom/tag_url.html">&lt;url&gt;</a>; <code>route</code>, <code>methods</code> and <code>name</code> all have the same meaning. In addition, there is a <code>macro</code> attribute which should be a reference to a <a class="tag" href="tags/httpmoyaprojectcom/tag_macro.html">&lt;macro&gt;</a> to call, and <code>stage</code> which defines the point in the url handling process where middleware should be called. The following is a list of possible <em>stages</em>:</p>
<dl class="dl-horizontal">
<dt>request</dt>
<dd>
Runs prior to any other requests.
</dd>
<dt>response</dt>
<dd>
Runs after a response has been generated. The response will be available in <code>.response</code>.
</dd>
</dl><p>Here's an example of adding middleware to a mountpoint:</p>
<pre class="moya-console format-xml"><a name="line1"></a><div class="line line-1"></span><span class="tag">&lt;</span><span class="tag tagname">mountpoint</span><span class="tag">&gt;</span></div><a name="line2"></a><div class="line line-2">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">middleware</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/"</span><span class="tag tagcontent">&nbsp;macro=</span><span class="attrib tag tagcontent">"middleware.sushi"</span><span class="tag tagcontent">&nbsp;stage=</span><span class="attrib tag tagcontent">"request"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line3"></a><div class="line line-3">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">url</span><span class="tag tagcontent">&nbsp;route=</span><span class="attrib tag tagcontent">"/product/</span><span class="braced attrib tag tagcontent">{product}</span><span class="attrib tag tagcontent">/"</span><span class="tag tagcontent">&nbsp;view=</span><span class="attrib tag tagcontent">"#view.product"</span><span class="tag">&gt;</span></div><a name="line4"></a><div class="line line-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">not-found</span><span class="tag tagcontent">&nbsp;if=</span><span class="attrib tag tagcontent">"url.product&nbsp;not&nbsp;in&nbsp;['nigiri',&nbsp;tuna-roll',&nbsp;'fugu']"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line5"></a><div class="line line-5">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="endtagname tag">/url</span><span class="tag">&gt;</span></div><a name="line6"></a><div class="line line-6"></span><span class="tag">&lt;</span><span class="tag tagname">mountpoint</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line7"></a><div class="line line-7"><br></div><a name="line8"></a><div class="line line-8"></span><span class="tag">&lt;</span><span class="tag tagname">macro</span><span class="tag tagcontent">&nbsp;libname=</span><span class="attrib tag tagcontent">"#middleware.sushi"</span><span class="tag">&gt;</span></div><a name="line9"></a><div class="line line-9">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tag">&lt;</span><span class="tag tagname">echo</span><span class="tag tagcontent">&nbsp;obj=</span><span class="attrib tag tagcontent">".request"</span><span class="tag tagcontent">&nbsp;</span><span class="endtagname tag">/</span><span class="tag">&gt;</span></div><a name="line10"></a><div class="line line-10"></span><span class="tag">&lt;</span><span class="endtagname tag">/macro</span><span class="tag">&gt;</span></div></pre><p>With the above code, every request under the mountpoint will invoke the macro (which prints the request to the console).</p>
<p>If the middleware code generates any kind of response (including redirects) then that will be served, and no more processing of URLs will occur.  In the case of middleware for the <code>response</code> stage, a response has already been generated, and can be inspected as <code>.response</code> &ndash; it is possible to modify this value, or issue a new response.
</p>
            

<div class="doc-nav">
    <ul class="pager">
        <li class="previous">
            <a href="templates.html">&larr; 11. Templates</a>
        </li>
        
        <li class="next">
            <a href="content.html">13. Content &rarr;</a>
        </li>
    </ul>
</div>


        </div>
        
        <div class="doctree-panel col-md-3">
        <ul>
    
    <li><a href="#mountpoints">Mountpoints</a><ul>
    
    <li><a href="#mountpoint-names">Mountpoint Names</a></li>
    
    <li><a href="#default-mountpoint">Default Mountpoint</a></li>
    
    <li><a href="#mount-shortcut">Mount Shortcut</a></li>
    
</ul></li>
    
    <li><a href="#url-routes">URL Routes</a><ul>
    
    <li><a href="#route-types">Route Types</a></li>
    
    <li><a href="#matching-paths">Matching Paths</a></li>
    
    <li><a href="#matching-methods">Matching Methods</a></li>
    
    <li><a href="#naming-routes">Naming Routes</a></li>
    
    <li><a href="#urls-container">URLS Container</a></li>
    
</ul></li>
    
    <li><a href="#generating-a-response">Generating a Response</a><ul>
    
    <li><a href="#rendering-templates">Rendering Templates</a></li>
    
    <li><a href="#serving-files">Serving Files</a></li>
    
    <li><a href="#redirects">Redirects</a></li>
    
    <li><a href="#not-found">Not Found</a></li>
    
    <li><a href="#forbidden">Forbidden</a></li>
    
    <li><a href="#other-responses">Other Responses</a></li>
    
</ul></li>
    
    <li><a href="#handlers">Handlers</a><ul>
    
    <li><a href="#default-handlers">Default Handlers</a></li>
    
</ul></li>
    
    <li><a href="#rewrites">Rewrites</a></li>
    
    <li><a href="#views">Views</a><ul>
    
    <li><a href="#template-views">Template Views</a></li>
    
    <li><a href="#explicit-template-data">Explicit Template Data</a></li>
    
    <li><a href="#content-views">Content Views</a></li>
    
</ul></li>
    
    <li><a href="#middleware">Middleware</a></li>
    
</ul>
        </div>
        
    </div>
</div>

    <div id="push"></div>

    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">Moya is &copy; 2014 <a href="#">Moya Software Foundation</a>.</p>
      </div>
    </div>

    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.js"></script>


</body>

</html>